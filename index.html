<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Assessment V21</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#0d9488', primaryLight: '#f0fdfa', primaryDark: '#115e59', secondary: '#64748b' } }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .text-yellow-custom { color: #d97706; font-weight: bold; background: #fef3c7; padding: 0 4px; border-radius: 2px; } 
        .text-red-custom { color: #dc2626; font-weight: bold; background: #fee2e2; padding: 0 4px; border-radius: 2px; }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-offline { background-color: #ef4444; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding-bottom: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .page-break { break-inside: avoid; page-break-inside: avoid; }
            input, select, textarea { border: 1px solid #ccc !important; background: white !important; color: black !important; }
            button { display: none !important; }
            .formatted-note-view { display: block !important; border: 1px solid #cbd5e1; padding: 12px; min-height: 150px; border-radius: 6px; white-space: pre-wrap; }
            dialog { display: none !important; }
            .tab-content { display: block !important; }
            .tab-nav-bar { display: none !important; }
        }
        .formatted-note-view { display: none; } 
        dialog { border: none; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 0; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Password Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-95 flex items-center justify-center z-[100] transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm mx-4">
            <div class="flex flex-col items-center mb-6">
                <div class="p-3 bg-primaryLight rounded-full mb-3"><svg class="w-6 h-6 text-primaryDark" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></div>
                <h3 class="text-lg font-bold text-slate-800">Site Assessment V21</h3>
                <p class="text-xs text-slate-500">System Locked</p>
            </div>
            <input type="password" id="password-input" placeholder="Enter password..." class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm text-center mb-4">
            <button id="unlock-button" class="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-primaryDark transition-colors shadow-md">Unlock</button>
            <p id="error-msg" class="text-red-500 text-xs mt-3 text-center hidden font-bold"></p>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden opacity-0 transition-opacity duration-500">
        <div id="root"></div>
    </div>

    <!-- 1. PASSWORD LOGIC -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CORRECT_PASSWORD = 'clean'; 
            const loginOverlay = document.getElementById('login-overlay');
            const appContainer = document.getElementById('app-container');
            const unlockButton = document.getElementById('unlock-button');
            const passwordInput = document.getElementById('password-input');
            const errorMsg = document.getElementById('error-msg');

            const attemptLogin = () => {
                if (passwordInput.value.trim() === CORRECT_PASSWORD) {
                    loginOverlay.classList.add('opacity-0');
                    setTimeout(() => { loginOverlay.style.display = 'none'; }, 300);
                    appContainer.classList.remove('hidden');
                    setTimeout(() => appContainer.classList.remove('opacity-0'), 50);
                } else {
                    errorMsg.textContent = 'Wrong Password';
                    errorMsg.classList.remove('hidden');
                    passwordInput.value = '';
                    loginOverlay.children[0].classList.add('animate-shake');
                    setTimeout(() => loginOverlay.children[0].classList.remove('animate-shake'), 500);
                }
            };
            unlockButton.onclick = attemptLogin;
            passwordInput.onkeyup = (e) => { errorMsg.classList.add('hidden'); if (e.key === 'Enter') attemptLogin(); };
        });
    </script>

    <!-- 2. FIREBASE MODULE (Runs first, attaches to window) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- ðŸ”´ FIREBASE CONFIG ðŸ”´ ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqcWqvSxf5fo7P-kAv_poZdQRabCe7OPM",
            authDomain: "site-assessment-db.firebaseapp.com",
            projectId: "site-assessment-db",
            storageBucket: "site-assessment-db.firebasestorage.app",
            messagingSenderId: "200478658724",
            appId: "1:200478658724:web:63c50046b6e31c44549631",
            measurementId: "G-T7HTQP7QGR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Attach to window so React can see them
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseSetDoc = setDoc;
        window.isFirebaseReady = true;

        // Notify React that Firebase is ready (in case React loaded first)
        document.dispatchEvent(new Event('firebase-ready'));
        console.log("Firebase Initialized");
    </script>

    <!-- 3. REACT APP (Babel Script) -->
    <script type="text/babel">
        const { useState, useEffect, useReducer, useMemo, useRef } = React;

        // --- Constants & Icons ---
        const DOC_ID = "current_site_assessment";
        const curtainTypes = ['Blackout', 'Day', 'Night', 'Roman Blinds', 'Belts'];
        const pleatTypes = ['Blackout', 'Day', 'Night'];
        
        const Icon = ({ children, className = "" }) => ( <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg> );
        const Icons = {
            Save: () => <Icon><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></Icon>,
            Trash2: () => <Icon><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>,
            Plus: () => <Icon><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>,
            User: () => <Icon><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></Icon>,
            Calculator: () => <Icon><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line></Icon>,
            CheckSquare: () => <Icon><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></Icon>,
            AppWindow: () => <Icon><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="M10 4v4"></path><path d="M2 8h20"></path><path d="M6 4v4"></path></Icon>,
            X: () => <Icon><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>,
            Settings: () => <Icon><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></Icon>,
            DollarSign: () => <Icon><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></Icon>,
            MapPin: () => <Icon className="w-4 h-4"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></Icon>,
            Hammer: () => <Icon><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></Icon>,
            Layers: () => <Icon><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></Icon>
        };

        // --- Helper Components ---
        const FormattedNote = ({ text }) => {
            if (!text) return null;
            const parts = text.split(/(\*[^*]+\*|#[^#]+#)/g);
            return (
                <div className="formatted-note-view text-sm font-mono bg-white">
                    {parts.map((part, index) => {
                        if (part.startsWith('*') && part.endsWith('*')) return <span key={index} className="text-yellow-custom">{part.slice(1, -1)}</span>;
                        if (part.startsWith('#') && part.endsWith('#')) return <span key={index} className="text-red-custom">{part.slice(1, -1)}</span>;
                        return <span key={index}>{part}</span>;
                    })}
                </div>
            );
        };
        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4 ${className}`}>{children}</div>;
        const CardHeader = ({ title, icon, onClick, className="" }) => (
            <div onClick={onClick} className={`bg-primaryLight px-4 py-3 border-b border-teal-100 flex items-center justify-between ${className}`}>
                <div className="flex items-center gap-2"><span className="text-primary">{icon}</span><h3 className="font-bold text-primaryDark tracking-wide text-sm uppercase">{title}</h3></div>
            </div>
        );
        const SectionTitle = ({ title }) => <div className="flex items-center gap-2 mt-8 mb-3 px-1"><div className="h-px bg-slate-300 flex-1"></div><h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest">{title}</h4><div className="h-px bg-slate-300 flex-1"></div></div>;
        const InputGroup = ({ label, value, onChange, type = "text", placeholder = "", disabled=false, step=null }) => (
            <div className="mb-3"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">{label}</label><input type={type} value={value} onChange={onChange} placeholder={placeholder} step={step} className={`w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm ${disabled ? 'bg-slate-100' : ''}`} disabled={disabled} /></div>
        );
        const TabButton = ({ label, icon, isActive, onClick }) => (
            <button onClick={onClick} className={`flex-1 py-3 px-2 flex flex-col items-center justify-center gap-1 text-xs font-bold uppercase tracking-wide transition-all border-b-2 ${isActive ? 'border-primary text-primary bg-primaryLight' : 'border-transparent text-slate-400 hover:bg-slate-50'}`}>{icon}<span>{label}</span></button>
        );

        // --- Initial Data ---
        const createEmptyCurtains = () => {
            const newCurtains = {};
            pleatTypes.forEach(type => { newCurtains[type] = [ { id: Date.now(), pleats: '', qty: 0 } ]; });
            newCurtains['Roman Blinds'] = { pleats: '', qty: 0, romanDims: { length: '', height: '', unit: 'cm' } };
            newCurtains['Belts'] = { pleats: '', qty: 0 };
            return newCurtains;
        };
        const defaultState = {
            customer: { name: '', address: '', contact: '', email: '', apptDate: '', collectionDate: '', cleanDate: '' },
            services: { windows: '', kitchenCondition: '', bedroomsCount: '', bathroomsCount: '', cupboards: '', rollerBlinds: '', mosquitoNets: '', balconies: '', others: '', neededCleaners: '', patchHoles: '', handymanNotes: '' },
            rooms: [ { id: 1, name: 'Living Rm', curtains: createEmptyCurtains() }, { id: 2, name: 'Dining Rm', curtains: createEmptyCurtains() }, { id: 3, name: 'Master Bedroom', curtains: createEmptyCurtains() }, { id: 4, name: 'Guest Rm', curtains: createEmptyCurtains() } ]
        };
        const defaultPrices = { Blackout: '1', Day: '1', Night: '1', 'Roman Blinds': '15', Belts: '2', pricePerCleaner: '50', cleaningSuppliesPrice: '0' };

        function appReducer(state, action) {
            switch (action.type) {
                case 'LOAD_FROM_CLOUD': return action.payload;
                case 'SET_CUSTOMER': return { ...state, customer: { ...state.customer, ...action.payload } };
                case 'SET_SERVICES': return { ...state, services: { ...state.services, ...action.payload } };
                case 'ADD_ROOM': return { ...state, rooms: [...state.rooms, { id: Date.now(), name: action.payload, curtains: createEmptyCurtains() }] };
                case 'DELETE_ROOM': return { ...state, rooms: state.rooms.filter(r => r.id !== action.payload) };
                case 'UPDATE_SINGLE_CURTAIN_DATA': return { ...state, rooms: state.rooms.map(room => room.id === action.payload.id ? { ...room, curtains: { ...room.curtains, [action.payload.type]: action.payload.newData } } : room )};
                case 'ADD_PLEAT_ITEM': return { ...state, rooms: state.rooms.map(room => room.id === action.payload.roomId ? { ...room, curtains: { ...room.curtains, [action.payload.type]: [ ...room.curtains[action.payload.type], { id: Date.now(), pleats: '', qty: 0 } ] } } : room )};
                case 'DELETE_PLEAT_ITEM': return { ...state, rooms: state.rooms.map(room => room.id === action.payload.roomId ? { ...room, curtains: { ...room.curtains, [action.payload.type]: room.curtains[action.payload.type].filter(item => item.id !== action.payload.itemId) } } : room )};
                case 'UPDATE_PLEAT_ITEM': return { ...state, rooms: state.rooms.map(room => room.id === action.payload.roomId ? { ...room, curtains: { ...room.curtains, [action.payload.type]: room.curtains[action.payload.type].map(item => item.id === action.payload.itemId ? action.payload.newData : item ) } } : room )};
                case 'RESET': return defaultState;
                default: return state;
            }
        }

        // --- Main App Component ---
        function App() {
            const [state, dispatch] = useReducer(appReducer, defaultState);
            const [priceList, setPriceList] = useState(defaultPrices);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('curtains');
            const [status, setStatus] = useState('connecting'); 

            // --- Safe Firebase Connection ---
            useEffect(() => {
                let unsub = null;
                const connect = () => {
                    if (window.isFirebaseReady && window.firebaseDB) {
                        try {
                            const db = window.firebaseDB;
                            const docRef = window.firebaseDoc(db, "site_assessments", DOC_ID);
                            unsub = window.firebaseOnSnapshot(docRef, (docSnap) => {
                                setStatus('online');
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (JSON.stringify(data.state) !== JSON.stringify(state)) {
                                        dispatch({ type: 'LOAD_FROM_CLOUD', payload: data.state || defaultState });
                                        if(data.priceList) setPriceList(data.priceList);
                                    }
                                } else {
                                    // Init default
                                    window.firebaseSetDoc(docRef, { state: defaultState, priceList: defaultPrices });
                                }
                            }, (err) => {
                                console.error(err);
                                setStatus('offline');
                            });
                        } catch (e) {
                            console.error("Firebase connection error", e);
                            setStatus('error');
                        }
                    } else {
                        // Wait for event
                        document.addEventListener('firebase-ready', connect, { once: true });
                    }
                };
                connect();
                return () => { if(unsub) unsub(); document.removeEventListener('firebase-ready', connect); };
            }, []);

            // Auto Save
            useEffect(() => {
                const handler = setTimeout(() => {
                    if (status === 'online' && window.firebaseDB) {
                        const db = window.firebaseDB;
                        const docRef = window.firebaseDoc(db, "site_assessments", DOC_ID);
                        window.firebaseSetDoc(docRef, { state, priceList }, { merge: true });
                    }
                }, 2000);
                return () => clearTimeout(handler);
            }, [state, priceList, status]);

            // Calculations
            const { curtainAmount, cleaningAmount, totalAmount, totalPieces } = useMemo(() => {
                let curtainTotal = 0;
                state.rooms.forEach(room => {
                    Object.entries(room.curtains).forEach(([type, data]) => {
                        const price = parseFloat(priceList[type]) || 0;
                        if (Array.isArray(data)) { 
                            data.forEach(item => {
                                const qty = parseInt(item.qty) || 0; if (qty === 0) return;
                                const pleats = parseInt(item.pleats) || 0;
                                curtainTotal += pleats * qty * price;
                            });
                        } else { 
                            const qty = parseInt(data.qty) || 0; if (qty === 0) return;
                            if (type === 'Roman Blinds') {
                                const dims = data.romanDims || {}; let length = parseFloat(dims.length) || 0; let height = parseFloat(dims.height) || 0;
                                if (dims.unit === 'cm') { length /= 100; height /= 100; }
                                curtainTotal += (length * height) * price * qty;
                            } else if (type === 'Belts') { curtainTotal += qty * price; }
                        }
                    });
                });
                const cleaners = parseFloat(state.services.neededCleaners) || 0;
                const pricePer = parseFloat(priceList.pricePerCleaner) || 0;
                const supplies = parseFloat(priceList.cleaningSuppliesPrice) || 0;
                const cleaningTotal = (cleaners * pricePer) + supplies;
                const pieces = state.rooms.reduce((total, room) => total + Object.values(room.curtains).reduce((sum, data) => {
                    if (Array.isArray(data)) return sum + data.reduce((s, i) => s + (parseInt(i.qty) || 0), 0);
                    return sum + (parseInt(data?.qty) || 0);
                }, 0), 0);
                return { curtainAmount: curtainTotal, cleaningAmount: cleaningTotal, totalAmount: curtainTotal + cleaningTotal, totalPieces: pieces };
            }, [state, priceList]);

            const handleReset = () => { if(confirm("Reset?")) { dispatch({ type: 'RESET' }); setPriceList(defaultPrices); } };

            if (status === 'connecting') {
                return <div className="flex items-center justify-center h-screen text-slate-500 flex-col gap-4"><div className="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div><p>Connecting to Database...</p></div>;
            }

            return (
                <div className="min-h-screen pb-24 bg-slate-50">
                    <nav className="bg-primary text-white px-4 py-3 shadow-lg sticky top-0 z-50 no-print">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="p-1.5 bg-white/20 rounded-lg"><Icons.CheckSquare /></div>
                                <div>
                                    <span className="font-bold tracking-wide block leading-none">SiteCheck V21</span>
                                    <div className="flex items-center gap-1 mt-1"><span className={`status-dot ${status === 'online' ? 'status-online' : 'status-offline'}`}></span><span className="text-[9px] uppercase font-bold opacity-80">{status === 'online' ? 'Online' : 'Offline'}</span></div>
                                </div>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 hover:bg-white/10 rounded-full"><Icons.Settings /></button>
                                <button onClick={handleReset} className="p-2 hover:bg-white/10 rounded-full"><Icons.Trash2 /></button>
                                <button onClick={() => window.print()} className="p-2 bg-white text-primary rounded-full shadow-md"><Icons.Save /></button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-md mx-auto p-4 print:max-w-none print:p-0">
                        <Card className="page-break border-t-4 border-t-primary">
                            <CardHeader title="Client Details" icon={<Icons.User />} />
                            <div className="p-5 space-y-4">
                                <InputGroup label="Name" value={state.customer.name} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { name: e.target.value }})} />
                                <InputGroup label="Address" value={state.customer.address} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { address: e.target.value }})} />
                                <div className="grid grid-cols-2 gap-4"><InputGroup label="Contact" value={state.customer.contact} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { contact: e.target.value }})} /><InputGroup label="Email" value={state.customer.email} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { email: e.target.value }})} /></div>
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 mt-2 grid grid-cols-2 gap-4"><InputGroup label="Appt Date" type="datetime-local" value={state.customer.apptDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { apptDate: e.target.value }})} /><InputGroup label="Collection Date" type="date" value={state.customer.collectionDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { collectionDate: e.target.value }})} /><div className="col-span-2"><InputGroup label="Clean / Install Date" type="date" value={state.customer.cleanDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { cleanDate: e.target.value }})} /></div></div>
                            </div>
                        </Card>

                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex overflow-hidden mb-5 tab-nav-bar">
                            <TabButton label="Curtains" icon={<Icons.Layers />} isActive={activeTab === 'curtains'} onClick={() => setActiveTab('curtains')} />
                            <TabButton label="Cleaning" icon={<Icons.AppWindow />} isActive={activeTab === 'cleaning'} onClick={() => setActiveTab('cleaning')} />
                            <TabButton label="Handyman" icon={<Icons.Hammer />} isActive={activeTab === 'handyman'} onClick={() => setActiveTab('handyman')} />
                            <TabButton label="Summary" icon={<Icons.Calculator />} isActive={activeTab === 'summary'} onClick={() => setActiveTab('summary')} />
                        </div>

                        <div className={`tab-content ${activeTab === 'curtains' ? 'block' : 'hidden'}`}>
                            <SectionTitle title="Room Assessment" />
                            <div className="space-y-5">
                                {state.rooms.map((room) => <RoomCard key={room.id} room={room} dispatch={dispatch} />)}
                                <button onClick={() => { const name = prompt("Enter Room Name:"); if (name) dispatch({ type: 'ADD_ROOM', payload: name }); }} className="w-full py-4 border-2 border-dashed border-primary/40 text-primary rounded-xl flex items-center justify-center gap-2 font-bold uppercase text-sm hover:bg-primaryLight no-print"><Icons.Plus /> Add Room</button>
                            </div>
                        </div>

                        <div className={`tab-content ${activeTab === 'cleaning' ? 'block' : 'hidden'}`}>
                            <SectionTitle title="Additional Info" />
                            <Card className="page-break">
                                <CardHeader title="Site Condition" icon={<Icons.AppWindow />} />
                                <div className="p-5 space-y-4">
                                    <div className="grid grid-cols-2 gap-4"><InputGroup label="No. of Windows" type="number" value={state.services.windows} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { windows: e.target.value }})} /><InputGroup label="Kitchen" value={state.services.kitchenCondition} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { kitchenCondition: e.target.value }})} /><InputGroup label="Bedrooms" type="number" value={state.services.bedroomsCount} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { bedroomsCount: e.target.value }})} /><InputGroup label="Bathrooms" type="number" value={state.services.bathroomsCount} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { bathroomsCount: e.target.value }})} /></div>
                                    <InputGroup label="Cupboards & Shelves" value={state.services.cupboards} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { cupboards: e.target.value }})} />
                                    <InputGroup label="Roller Blinds" value={state.services.rollerBlinds} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { rollerBlinds: e.target.value }})} />
                                    <div className="grid grid-cols-2 gap-4"><InputGroup label="Mosquito-nets" type="number" value={state.services.mosquitoNets} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { mosquitoNets: e.target.value }})} /><InputGroup label="Balconies" type="number" value={state.services.balconies} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { balconies: e.target.value }})} /></div>
                                    <div className="pt-4 border-t border-slate-200 mt-2 grid grid-cols-2 gap-4"><InputGroup label="Cleaners" type="number" step="0.5" value={state.services.neededCleaners} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { neededCleaners: e.target.value }})} /><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Est. Cost</label><input type="text" value={`$${cleaningAmount.toFixed(2)}`} disabled className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-100 font-bold" /></div></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-2">Inspector Notes</label><textarea rows="6" className="w-full px-4 py-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary bg-slate-50" value={state.services.others} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { others: e.target.value }})}></textarea><FormattedNote text={state.services.others} /></div>
                                </div>
                            </Card>
                        </div>

                        <div className={`tab-content ${activeTab === 'handyman' ? 'block' : 'hidden'}`}>
                            <SectionTitle title="Handyman" />
                            <Card className="page-break">
                                <CardHeader title="Handyman Services" icon={<Icons.Hammer />} />
                                <div className="p-5 space-y-4">
                                    <div className="w-1/2 pr-2"><InputGroup label="Patch Holes" value={state.services.patchHoles} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { patchHoles: e.target.value }})} /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-2">Description</label><textarea rows="6" className="w-full px-4 py-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary bg-slate-50" value={state.services.handymanNotes} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { handymanNotes: e.target.value }})}></textarea><FormattedNote text={state.services.handymanNotes} /></div>
                                </div>
                            </Card>
                        </div>

                        <div className={`tab-content ${activeTab === 'summary' ? 'block' : 'hidden'}`}>
                            <SectionTitle title="Quotation" />
                            <Card className="bg-gradient-to-br from-white to-slate-50 border-primary/20 page-break shadow-md">
                                <CardHeader title="Summary" icon={<Icons.Calculator />} />
                                <div className="p-5">
                                    <div className="flex justify-between items-center mb-6 pb-6 border-b border-slate-200"><span className="font-bold text-slate-500 uppercase text-xs tracking-wider">Total Curtain Qty</span><span className="text-3xl font-bold text-slate-700">{totalPieces} <span className="text-sm font-normal text-slate-400">pcs</span></span></div>
                                    <div className="mb-4"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Curtains Price ($)</label><input type="text" value={curtainAmount.toFixed(2)} disabled className="w-full text-right text-2xl font-bold text-slate-700 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2" /></div>
                                    <div className="bg-primaryLight p-4 rounded-xl border border-primary/20"><label className="block text-xs font-bold text-primaryDark uppercase mb-1">Grand Total ($)</label><input type="text" value={totalAmount.toFixed(2)} readOnly className="w-full text-right text-3xl font-bold text-primary bg-transparent outline-none" /></div>
                                </div>
                            </Card>
                        </div>

                        <div className="hidden print:flex mt-12 pt-8 border-t-2 border-slate-200 page-break justify-between items-end"><div className="text-center w-1/3"><div className="h-16 border-b border-slate-400 mb-2"></div><div className="text-xs font-bold text-slate-500 uppercase">Customer</div></div><div className="text-center w-1/3"><div className="h-16 border-b border-slate-400 mb-2"></div><div className="text-xs font-bold text-slate-500 uppercase">Inspector</div></div></div>
                        <div className="text-center mt-8 no-print text-slate-400 text-xs">Â© Site Assessment V21</div>
                    </main>
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} priceList={priceList} setPriceList={setPriceList} />
                </div>
            );
        }

        // --- Child Components ---
        function SettingsModal({ isOpen, onClose, priceList, setPriceList }) {
            const dialogRef = useRef(null);
            useEffect(() => { if (isOpen) dialogRef.current?.showModal(); else dialogRef.current?.close(); }, [isOpen]);
            const handleChange = (key, val) => setPriceList(prev => ({ ...prev, [key]: val }));
            return (
                <dialog ref={dialogRef} onClose={onClose} className="w-full max-w-md p-0 no-print">
                    <div className="flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b border-slate-200"><h3 className="text-lg font-bold text-slate-800">Price List</h3><button onClick={onClose}><Icons.X /></button></div>
                        <div className="p-6 space-y-4 bg-slate-50">
                            {curtainTypes.map(t => (<div key={t} className="flex items-center gap-2"><label className="w-1/2 text-sm font-medium">{t}</label><input type="number" value={priceList[t] || ''} onChange={e => handleChange(t, e.target.value)} className="w-1/2 px-3 py-2 border rounded-lg text-sm" /></div>))}
                            <div className="border-t pt-4 mt-4"><div className="flex items-center gap-2"><label className="w-1/2 text-sm font-medium">Cleaner Rate</label><input type="number" value={priceList['pricePerCleaner'] || ''} onChange={e => handleChange('pricePerCleaner', e.target.value)} className="w-1/2 px-3 py-2 border rounded-lg text-sm" /></div></div>
                            <div className="flex items-center gap-2"><label className="w-1/2 text-sm font-medium">Supplies Fee</label><input type="number" value={priceList['cleaningSuppliesPrice'] || ''} onChange={e => handleChange('cleaningSuppliesPrice', e.target.value)} className="w-1/2 px-3 py-2 border rounded-lg text-sm" /></div>
                        </div>
                        <div className="p-4 bg-slate-100 border-t text-right"><button onClick={onClose} className="bg-primary text-white px-5 py-2 rounded-lg font-semibold text-sm">Done</button></div>
                    </div>
                </dialog>
            );
        }

        function RoomCard({ room, dispatch }) {
            const total = useMemo(() => Object.values(room.curtains).reduce((sum, data) => { if (Array.isArray(data)) { return sum + data.reduce((arrSum, item) => arrSum + (parseInt(item.qty) || 0), 0); } else { return sum + (parseInt(data?.qty) || 0); } }, 0), [room.curtains]);
            return (
                <Card className="page-break transition-all hover:shadow-md">
                    <div className="bg-white px-4 py-3 border-b border-slate-100 flex justify-between items-center"><span className="font-bold text-slate-700 text-lg">{room.name}</span><div className="flex items-center gap-3"><span className="text-xs font-bold px-2.5 py-1 rounded-full bg-primaryLight text-primary border border-teal-100">{total} pcs</span><button onClick={() => { if(confirm("Delete room?")) dispatch({ type: 'DELETE_ROOM', payload: room.id }); }} className="text-slate-300 hover:text-red-500 no-print"><Icons.X /></button></div></div>
                    <div className="p-3 bg-white">
                        {curtainTypes.map(type => {
                            if (pleatTypes.includes(type)) {
                                return (
                                    <div key={type} className="py-3 border-b border-slate-100 last:border-0">
                                        {room.curtains[type].map((item, idx) => <CurtainInput key={item.id} label={type} data={item} onChange={d => dispatch({ type: 'UPDATE_PLEAT_ITEM', payload: { roomId: room.id, type, itemId: item.id, newData: d } })} onDelete={() => dispatch({ type: 'DELETE_PLEAT_ITEM', payload: { roomId: room.id, type, itemId: item.id } })} isPleatType={true} showLabel={idx === 0} canDelete={room.curtains[type].length > 1} />)}
                                        <div className="flex justify-end mt-2 pr-12 no-print"><button onClick={() => dispatch({ type: 'ADD_PLEAT_ITEM', payload: { roomId: room.id, type } })} className="flex items-center gap-1 text-xs text-primary font-bold opacity-70 hover:opacity-100"><Icons.Plus /> Add {type}</button></div>
                                    </div>
                                );
                            } else { return <CurtainInput key={type} label={type} data={room.curtains[type]} onChange={d => dispatch({ type: 'UPDATE_SINGLE_CURTAIN_DATA', payload: { id: room.id, type, newData: d } })} isPleatType={false} showLabel={true} canDelete={false} />; }
                        })}
                    </div>
                </Card>
            );
        }

        function CurtainInput({ label, data, onChange, onDelete, isPleatType, showLabel, canDelete }) {
            const isRoman = label === 'Roman Blinds'; const isBelt = label === 'Belts';
            const romanDims = data.romanDims || { length: '', height: '', unit: 'cm' };
            return (
                <div className={isPleatType ? "py-1.5" : "py-3 border-b border-slate-100 last:border-0"}>
                    <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                        <div className="flex items-center gap-2 w-full sm:w-1/3">
                           {showLabel ? <span className={`text-sm font-medium ${isRoman || isPleatType ? 'text-primaryDark font-bold' : 'text-slate-700'}`}>{label}</span> : <button onClick={onDelete} disabled={!canDelete} className={`text-slate-300 hover:text-red-500 no-print ml-1 ${!canDelete && 'opacity-50'}`}><Icons.X /></button>}
                        </div>
                        <div className="flex items-center gap-2 w-full sm:w-2/3 justify-end">
                            <div className="flex-1">
                                {isRoman && <div className="flex items-center gap-1"><input type="number" value={romanDims.length} onChange={e => onChange({ ...data, romanDims: { ...romanDims, length: e.target.value } })} placeholder="Len" className="w-1/3 min-w-[50px] px-1 py-1 border rounded text-sm" /><span className="text-slate-400 text-xs">x</span><input type="number" value={romanDims.height} onChange={e => onChange({ ...data, romanDims: { ...romanDims, height: e.target.value } })} placeholder="Hgt" className="w-1/3 min-w-[50px] px-1 py-1 border rounded text-sm" /><select value={romanDims.unit} onChange={e => onChange({ ...data, romanDims: { ...romanDims, unit: e.target.value } })} className="w-1/3 min-w-[50px] border text-xs rounded px-1 py-1 bg-slate-50"><option value="cm">cm</option><option value="m">m</option></select></div>}
                                {isPleatType && <div className="relative max-w-[120px]"><input type="number" value={data.pleats || ''} onChange={e => onChange({ ...data, pleats: e.target.value })} placeholder="Pleats No." className="w-full px-2 py-1 text-center border rounded text-sm" /></div>}
                                {isBelt && <div className="relative max-w-[120px]"><input type="text" value="Per Piece" disabled className="w-full px-2 py-1 text-center border bg-slate-50 text-slate-400 rounded text-sm" /></div>}
                            </div>
                            <div className="flex items-center gap-1 ml-2"><button onClick={() => onChange({ ...data, qty: Math.max(0, (data.qty || 0) - 1) })} className="w-7 h-7 flex items-center justify-center rounded bg-slate-100 text-slate-600 no-print">-</button><div className="w-10 text-center"><input type="number" value={data.qty || 0} onChange={e => onChange({ ...data, qty: parseInt(e.target.value) || 0 })} className="w-full text-center py-1 border rounded text-sm font-bold text-primaryDark" /></div><button onClick={() => onChange({ ...data, qty: (data.qty || 0) + 1 })} className="w-7 h-7 flex items-center justify-center rounded bg-primary text-white no-print">+</button></div>
                            {isPleatType && showLabel && <button onClick={onDelete} disabled={!canDelete} className={`text-slate-300 hover:text-red-500 no-print ml-1 ${!canDelete && 'opacity-0'}`}><Icons.X /></button>}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


