<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mrs. Sparkle - Premium Access</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: { 
                    colors: { 
                        primary: 'var(--color-primary)', 
                        primaryLight: 'var(--color-primary-light)', 
                        primaryDark: 'var(--color-primary-dark)', 
                        secondary: '#64748b' 
                    },
                    animation: { 
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'fade-out': 'fadeOut 0.3s ease-in forwards'
                    },
                    keyframes: { 
                        'float': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        'slideUp': { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        'fadeOut': { '0%': { opacity: '1' }, '100%': { opacity: '0' } }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --color-primary: #0f766e;
            --color-primary-light: #f0fdfa;
            --color-primary-dark: #115e59;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        .print-only { display: none; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1); }
        input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus, input:-webkit-autofill:active{ -webkit-box-shadow: 0 0 0 30px white inset !important; }

        /* Highlight Styles */
        .text-yellow-custom { color: #b45309; font-weight: 800; background: #fef3c7; padding: 2px 6px; border-radius: 4px; display: inline-block; margin: 0 2px; border: 1px solid #fcd34d; } 
        .text-red-custom { color: #b91c1c; font-weight: 800; background: #fee2e2; padding: 2px 6px; border-radius: 4px; display: inline-block; margin: 0 2px; border: 1px solid #fca5a5; } 

        @media print {
            @page { size: Letter; margin: 10mm; } 
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; color: #000; font-size: 11px; }
            .no-print, nav, button, .tab-nav-bar, .status-dot, #login-overlay, .toast-container { display: none !important; }
            .print-hidden-section { display: none !important; }
            #app-container, main { padding: 0 !important; margin: 0 !important; max-width: 100% !important; width: 100% !important; }
            .print-only { display: block !important; }
            .tab-content { display: block !important; margin-bottom: 15px; }
            .card-container { box-shadow: none !important; border: none !important; border-bottom: 1px solid #eee !important; border-radius: 0 !important; margin-bottom: 10px !important; background: white !important; break-inside: avoid; }
            .card-header { background: #f1f5f9 !important; color: #000 !important; border: none !important; padding: 4px 0 !important; margin-bottom: 5px !important; }
            .card-header h3 { color: #000 !important; font-size: 12px !important; font-weight: 800 !important; text-transform: uppercase; }
            input, textarea, select { border: none !important; background: transparent !important; padding: 0 !important; margin: 0 !important; font-weight: 600 !important; color: #000 !important; height: auto !important; -moz-appearance: textfield; box-shadow: none !important; }
            input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
            .curtain-print-row { display: grid !important; grid-template-columns: 1fr 80px 40px !important; align-items: center !important; padding: 4px 0 !important; border-bottom: 1px dotted #e2e8f0; gap: 10px; }
            .curtain-print-left { width: auto !important; max-width: none !important; } 
            .curtain-print-right { width: auto !important; justify-content: flex-end !important; display: contents !important; }
            .print-pleats-col { text-align: center !important; justify-self: center !important; width: auto !important; margin: 0 !important; }
            .print-qty-col { text-align: center !important; justify-self: center !important; font-weight: 800 !important; width: auto !important; margin: 0 !important; }
            .print-pleats-input { width: 100% !important; text-align: center !important; }
            .print-qty-input { width: 100% !important; text-align: center !important; }
            .print-header { display: flex !important; justify-content: space-between; border-bottom: 2px solid var(--color-primary); padding-bottom: 10px; margin-bottom: 20px; }
            .print-footer { position: fixed; bottom: 0; left: 0; width: 100%; border-top: 1px solid #ccc; padding-top: 5px; background: white; }
            .print-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .formatted-note-view { border: 1px solid #ddd !important; padding: 10px !important; border-radius: 8px !important; display: flex !important; flex-wrap: wrap; gap: 4px !important; margin-top: 5px !important; }
        }
        dialog { border: none; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); padding: 0; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-offline { background-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="login-overlay" class="fixed inset-0 z-[100] flex justify-center items-center p-6 transition-all duration-700 bg-gradient-to-br from-primary via-primaryDark to-slate-900">
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
            <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-white rounded-full mix-blend-overlay filter blur-[100px] opacity-20 animate-float"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-primaryLight rounded-full mix-blend-overlay filter blur-[100px] opacity-20 animate-float" style="animation-delay: 2s;"></div>
        </div>
        <div class="w-full max-w-sm flex flex-col items-center relative z-10 glass-card rounded-3xl p-8 transform transition-all duration-300 scale-100">
            <div class="w-24 h-24 bg-primary rounded-full flex items-center justify-center mb-6 shadow-xl border-4 border-white/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
            </div>
            <h1 class="text-2xl font-extrabold text-slate-800 mb-1 tracking-tight text-center">Hello, Sparkle Team</h1>
            <p class="text-slate-500 text-sm mb-8 font-medium text-center">Please verify access code</p>
            <div class="w-full space-y-5">
                <div class="relative group">
                    <input type="password" id="password-input" class="w-full bg-white text-slate-800 text-center font-bold text-xl rounded-2xl py-4 px-6 focus:ring-4 focus:ring-primary/20 focus:border-primary border-2 border-slate-100 transition-all outline-none placeholder:text-slate-300 shadow-sm" placeholder="••••••">
                     <button id="toggle-pwd" class="absolute right-5 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-primary transition-colors p-2">
                        <svg id="eye-off" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                        <svg id="eye-on" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                <button id="unlock-button" class="w-full bg-gradient-to-r from-primary to-primaryDark hover:opacity-90 text-white font-bold rounded-2xl py-4 transition-all duration-300 shadow-lg shadow-primary/30 active:scale-95 flex items-center justify-center gap-2 transform hover:-translate-y-0.5"><span>Login</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg></button>
            </div>
            <div id="error-msg" class="mt-6 text-red-500 text-sm font-bold hidden bg-red-50 px-4 py-2 rounded-xl border border-red-100 flex items-center gap-2 animate-bounce w-full justify-center">Wrong Access Code</div>
            <div class="mt-8 text-[10px] text-slate-400 font-bold tracking-widest uppercase">Mrs. Sparkle V25</div>
        </div>
    </div>

    <div id="app-container" class="hidden opacity-0 transition-opacity duration-500"><div id="root"></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const PWD = 'clean'; const loginOverlay = document.getElementById('login-overlay'); const appContainer = document.getElementById('app-container'); const unlockButton = document.getElementById('unlock-button'); const passwordInput = document.getElementById('password-input'); const errorMsg = document.getElementById('error-msg'); const toggleBtn = document.getElementById('toggle-pwd'); const eyeOff = document.getElementById('eye-off'); const eyeOn = document.getElementById('eye-on');
            toggleBtn.onclick = () => { if(passwordInput.type === "password") { passwordInput.type = "text"; eyeOff.classList.add('hidden'); eyeOn.classList.remove('hidden'); } else { passwordInput.type = "password"; eyeOff.classList.remove('hidden'); eyeOn.classList.add('hidden'); } passwordInput.focus(); };
            const attemptLogin = () => { passwordInput.blur(); if (passwordInput.value.trim() === PWD) { loginOverlay.style.opacity = '0'; loginOverlay.style.transform = 'scale(1.05)'; setTimeout(() => { loginOverlay.style.display = 'none'; }, 600); appContainer.classList.remove('hidden'); setTimeout(() => appContainer.classList.remove('opacity-0'), 50); } else { errorMsg.classList.remove('hidden'); passwordInput.classList.add('ring-2', 'ring-red-500', 'bg-red-50'); setTimeout(() => passwordInput.classList.remove('ring-2', 'ring-red-500', 'bg-red-50'), 2000); passwordInput.value = ''; } };
            unlockButton.onclick = attemptLogin; passwordInput.onkeyup = (e) => { errorMsg.classList.add('hidden'); if (e.key === 'Enter') attemptLogin(); };
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"; import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyBqcWqvSxf5fo7P-kAv_poZdQRabCe7OPM", authDomain: "site-assessment-db.firebaseapp.com", projectId: "site-assessment-db", storageBucket: "site-assessment-db.firebasestorage.app", messagingSenderId: "200478658724", appId: "1:200478658724:web:63c50046b6e31c44549631", measurementId: "G-T7HTQP7QGR" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); window.firebaseDB = db; window.firebaseDoc = doc; window.firebaseOnSnapshot = onSnapshot; window.firebaseSetDoc = setDoc; window.isFirebaseReady = true; document.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useReducer, useMemo, useRef } = React;
        const DOC_ID = "current_site_assessment";
        const curtainTypes = ['Blackout', 'Day', 'Night', 'Roman Blinds', 'Belts'];
        const pleatTypes = ['Blackout', 'Day', 'Night'];
        
        // Themes Config
        const themes = {
            teal: { primary: '#0f766e', light: '#f0fdfa', dark: '#115e59', name: 'Sparkle Teal' },
            blue: { primary: '#2563eb', light: '#eff6ff', dark: '#1e40af', name: 'Ocean Blue' },
            purple: { primary: '#7e22ce', light: '#faf5ff', dark: '#581c87', name: 'Royal Purple' },
            rose: { primary: '#be123c', light: '#fff1f2', dark: '#9f1239', name: 'Ruby Red' },
            amber: { primary: '#d97706', light: '#fffbeb', dark: '#b45309', name: 'Golden Amber' },
            slate: { primary: '#475569', light: '#f8fafc', dark: '#334155', name: 'Minimalist' }
        };

        const defaultState = { 
            customer: { name: '', address: '', contact: '', email: '', apptDate: '', collectionDate: '', cleanDate: '' }, 
            services: { windows: '', kitchenCondition: '', bedroomsCount: '', bathroomsCount: '', cupboards: '', rollerBlinds: '', mosquitoNets: '', balconies: '', others: '', neededCleaners: '', patchHoles: '', handymanNotes: '' }, 
            rooms: [ { id: 1, name: 'Living Rm', curtains: createEmptyCurtains() }, { id: 2, name: 'Dining Rm', curtains: createEmptyCurtains() }, { id: 3, name: 'Master Bedroom', curtains: createEmptyCurtains() }, { id: 4, name: 'Guest Rm', curtains: createEmptyCurtains() } ], 
            settings: { companyName: 'Mrs. Sparkle', bankInfo: '', terms: '', theme: 'teal', logo: null, docType: 'Quotation' } 
        };
        const defaultPrices = { Blackout: '1', Day: '1', Night: '1', 'Roman Blinds': '15', Belts: '2', pricePerCleaner: '50', cleaningSuppliesPrice: '0' };

        // Components
        const Icon = ({ children, className = "" }) => ( <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg> );
        const Icons = { Save: () => <Icon><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></Icon>, Trash2: () => <Icon><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>, Plus: () => <Icon><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>, User: () => <Icon><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></Icon>, Calculator: () => <Icon><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line></Icon>, CheckSquare: () => <Icon><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></Icon>, AppWindow: () => <Icon><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="M10 4v4"></path><path d="M2 8h20"></path><path d="M6 4v4"></path></Icon>, X: () => <Icon><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>, Settings: () => <Icon><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></Icon>, Hammer: () => <Icon><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></Icon>, Layers: () => <Icon><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></Icon>, Upload: () => <Icon><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></Icon> };

        // Toast Component
        const Toast = ({ show, message, type }) => {
            if (!show) return null;
            return (
                <div className={`fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-[100] animate-slide-up bg-slate-800 text-white no-print`}>
                    <div className={`w-2 h-2 rounded-full ${type === 'success' ? 'bg-green-400' : 'bg-red-400'}`}></div>
                    <span className="font-bold text-sm">{message}</span>
                </div>
            );
        };

        const FormattedNote = ({ text }) => {
            if (!text) return null;
            // Use flex-wrap to allow flow, gap-1 for spacing
            return (
                <div className="formatted-note-view text-sm font-mono mt-2 p-3 border-2 border-slate-200 rounded-xl w-full bg-white flex flex-wrap gap-1 items-center shadow-sm">
                    {text.split(/(\*[^*]+\*|#[^#]+#)/g).map((part, index) => {
                        if (part === "") return null;
                        if (part.startsWith('*') && part.endsWith('*')) {
                            return <span key={index} className="text-yellow-custom">{part.slice(1, -1)}</span>;
                        }
                        if (part.startsWith('#') && part.endsWith('#')) {
                            return <span key={index} className="text-red-custom">{part.slice(1, -1)}</span>;
                        }
                        return <span key={index} className="text-slate-700 whitespace-pre-wrap leading-relaxed">{part}</span>;
                    })}
                </div>
            );
        };

        const PrintItem = ({ label, value }) => {
            if (!value || value == 0 || value == '0') return null;
            return (
                <div className="flex justify-between items-end py-2 border-b border-slate-300 break-inside-avoid">
                    <span className="text-[10px] font-black text-slate-800 uppercase tracking-wider">{label}</span>
                    <span className="text-sm font-bold text-slate-900 text-right">{value}</span>
                </div>
            );
        };

        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4 card-container ${className}`}>{children}</div>;
        const CardHeader = ({ title, icon, onClick, className="" }) => (<div onClick={onClick} className={`bg-primaryLight px-4 py-3 border-b border-teal-100 flex items-center justify-between card-header ${className}`}><div className="flex items-center gap-2"><span className="text-primary">{icon}</span><h3 className="font-bold text-primaryDark tracking-wide text-sm uppercase">{title}</h3></div></div>);
        const SectionTitle = ({ title }) => <div className="flex items-center gap-2 mt-8 mb-3 px-1 section-title no-print"><div className="h-px bg-slate-300 flex-1"></div><h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest">{title}</h4><div className="h-px bg-slate-300 flex-1"></div></div>;
        const InputGroup = ({ label, value, onChange, type = "text", placeholder = "", disabled=false, step=null, labelClass="" }) => (
            <div className="mb-3 input-group">
                <label className={`block text-xs uppercase mb-1 ml-1 ${labelClass || 'font-bold text-slate-600'}`}>{label}</label>
                <input type={type} value={value} onChange={onChange} placeholder={placeholder} step={step} className={`w-full px-3 py-2.5 border border-slate-300 bg-slate-50 rounded-lg focus:outline-none focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-sm text-sm font-medium text-slate-700 ${disabled ? 'bg-slate-100 text-slate-400' : ''}`} disabled={disabled} />
            </div>
        );
        const TabButton = ({ label, icon, isActive, onClick }) => (<button onClick={onClick} className={`flex-1 py-3 px-2 flex flex-col items-center justify-center gap-1 text-xs font-bold uppercase tracking-wide transition-all border-b-2 ${isActive ? 'border-primary text-primary bg-primaryLight' : 'border-transparent text-slate-400 hover:bg-slate-50'}`}>{icon}<span>{label}</span></button>);

        function createEmptyCurtains() { const newCurtains = {}; pleatTypes.forEach(type => { newCurtains[type] = [ { id: Date.now(), pleats: '', qty: 0 } ]; }); newCurtains['Roman Blinds'] = { pleats: '', qty: 0, romanDims: { length: '', height: '', unit: 'cm' } }; newCurtains['Belts'] = { pleats: '', qty: 0 }; return newCurtains; }

        function appReducer(state, action) {
            switch (action.type) {
                case 'LOAD_FROM_CLOUD': return { ...defaultState, ...action.payload };
                case 'SET_CUSTOMER': return { ...state, customer: { ...state.customer, ...action.payload } };
                case 'SET_SERVICES': return { ...state, services: { ...state.services, ...action.payload } };
                case 'SET_SETTINGS': return { ...state, settings: { ...state.settings, ...action.payload } };
                case 'ADD_ROOM': return { ...state, rooms: [...state.rooms, { id: Date.now(), name: action.payload, curtains: createEmptyCurtains() }] };
                case 'DELETE_ROOM': return { ...state, rooms: state.rooms.filter(r => r.id !== action.payload) };
                case 'UPDATE_SINGLE_CURTAIN_DATA': return { ...state, rooms: state.rooms.map(room => room.id === action.payload.id ? { ...room, curtains: { ...room.curtains, [action.payload.type]: action.payload.newData } } : room )};
                case 'ADD_PLEAT_ITEM': return { ...state, rooms: state.rooms.map(room => room.id === action.payload.roomId ? { ...room, curtains: { ...room.curtains, [action.payload.type]: [ ...room.curtains[action.payload.type], { id: Date.now(), pleats: '', qty: 0 } ] } } : room )};
                case 'DELETE_PLEAT_ITEM': return { ...state, rooms: state.rooms.map(room => room.id === action.payload.roomId ? { ...room, curtains: { ...room.curtains, [action.payload.type]: room.curtains[action.payload.type].filter(item => item.id !== action.payload.itemId) } } : room )};
                case 'UPDATE_PLEAT_ITEM': return { ...state, rooms: state.rooms.map(room => room.id === action.payload.roomId ? { ...room, curtains: { ...room.curtains, [action.payload.type]: room.curtains[action.payload.type].map(item => item.id === action.payload.itemId ? action.payload.newData : item ) } } : room )};
                case 'RESET': return defaultState;
                default: return state;
            }
        }

        function App() {
            const [state, dispatch] = useReducer(appReducer, defaultState);
            const [priceList, setPriceList] = useState(defaultPrices);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('curtains');
            const [status, setStatus] = useState('connecting');
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });

            const showToast = (msg, type = 'success') => {
                setToast({ show: true, message: msg, type });
                setTimeout(() => setToast(prev => ({ ...prev, show: false })), 3000);
            };

            useEffect(() => {
                const currentThemeKey = state.settings.theme || 'teal';
                const theme = themes[currentThemeKey] || themes.teal;
                const root = document.documentElement;
                root.style.setProperty('--color-primary', theme.primary);
                root.style.setProperty('--color-primary-light', theme.light);
                root.style.setProperty('--color-primary-dark', theme.dark);
            }, [state.settings.theme]);

            useEffect(() => {
                let unsub = null;
                const connect = () => {
                    if (window.isFirebaseReady && window.firebaseDB) {
                        try {
                            const db = window.firebaseDB;
                            const docRef = window.firebaseDoc(db, "site_assessments", DOC_ID);
                            unsub = window.firebaseOnSnapshot(docRef, (docSnap) => {
                                setStatus('online');
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (JSON.stringify(data.state) !== JSON.stringify(state)) {
                                        dispatch({ type: 'LOAD_FROM_CLOUD', payload: data.state || defaultState });
                                        if(data.priceList) setPriceList(data.priceList);
                                    }
                                } else { window.firebaseSetDoc(docRef, { state: defaultState, priceList: defaultPrices }); }
                            }, (err) => { console.error(err); setStatus('offline'); });
                        } catch (e) { console.error(e); setStatus('error'); }
                    } else { document.addEventListener('firebase-ready', connect, { once: true }); }
                };
                connect();
                return () => { if(unsub) unsub(); document.removeEventListener('firebase-ready', connect); };
            }, []);

            useEffect(() => {
                const handler = setTimeout(() => {
                    if (status === 'online' && window.firebaseDB) {
                        const db = window.firebaseDB;
                        const docRef = window.firebaseDoc(db, "site_assessments", DOC_ID);
                        window.firebaseSetDoc(docRef, { state, priceList }, { merge: true })
                            .then(() => {})
                            .catch(err => console.error("Auto-save failed", err));
                    }
                }, 2000);
                return () => clearTimeout(handler);
            }, [state, priceList, status]);

            const { curtainAmount, cleaningAmount, totalAmount, totalPieces } = useMemo(() => {
                let curtainTotal = 0;
                state.rooms.forEach(room => {
                    Object.entries(room.curtains).forEach(([type, data]) => {
                        const price = parseFloat(priceList[type]) || 0;
                        if (Array.isArray(data)) { 
                            data.forEach(item => { if ((parseInt(item.qty) || 0) > 0) curtainTotal += (parseInt(item.pleats) || 0) * parseInt(item.qty) * price; }); 
                        } else { 
                            if ((parseInt(data.qty) || 0) > 0) { 
                                if (type === 'Roman Blinds') { 
                                    let l = parseFloat(data.romanDims?.length)||0; let h = parseFloat(data.romanDims?.height)||0; const u = data.romanDims?.unit || 'cm';
                                    let area = 0; if(u === 'cm') area = (l/100) * (h/100); else if(u === 'm') area = l * h; else if(u === 'in') area = (l * 0.0254) * (h * 0.0254); else if(u === 'ft') area = (l * 0.3048) * (h * 0.3048);
                                    curtainTotal += area * price * data.qty; 
                                } else { curtainTotal += data.qty * price; } 
                            } 
                        }
                    });
                });
                const cleaningTotal = ((parseFloat(state.services.neededCleaners)||0) * (parseFloat(priceList.pricePerCleaner)||0)) + (parseFloat(priceList.cleaningSuppliesPrice)||0);
                const pieces = state.rooms.reduce((t, r) => t + Object.values(r.curtains).reduce((s, d) => Array.isArray(d) ? s + d.reduce((ss, i) => ss + (parseInt(i.qty)||0), 0) : s + (parseInt(d.qty)||0), 0), 0);
                return { curtainAmount: curtainTotal, cleaningAmount: cleaningTotal, totalAmount: curtainTotal + cleaningTotal, totalPieces: pieces };
            }, [state, priceList]);

            const handleReset = () => { if(confirm("Reset?")) { dispatch({ type: 'RESET' }); setPriceList(defaultPrices); showToast("All data reset", 'success'); } };
            const handlePrint = () => { showToast("Preparing Print...", 'success'); setTimeout(() => window.print(), 500); };
            const isCleaningEmpty = !state.services.kitchenCondition && !state.services.bedroomsCount && !state.services.bathroomsCount && !state.services.neededCleaners && !state.services.others;
            const isHandymanEmpty = !state.services.patchHoles && !state.services.handymanNotes;
            const boldLabelClass = "font-black text-primaryDark text-sm uppercase";

            if (status === 'connecting') return <div className="flex items-center justify-center h-screen text-slate-500 flex-col gap-4"><div className="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div><p>Connecting...</p></div>;

            return (
                <div className="min-h-screen pb-24 bg-slate-50">
                    <Toast show={toast.show} message={toast.message} type={toast.type} />
                    <nav className="bg-primary text-white px-4 py-3 shadow-lg sticky top-0 z-50 no-print transition-colors duration-300">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2"><div className="p-1.5 bg-white/20 rounded-lg"><Icons.CheckSquare /></div><div><span className="font-bold tracking-wide block leading-none">SiteCheck V25</span><div className="flex items-center gap-1 mt-1"><span className={`status-dot ${status === 'online' ? 'status-online' : 'status-offline'}`}></span><span className="text-[9px] uppercase font-bold opacity-80">{status === 'online' ? 'Online' : 'Offline'}</span></div></div></div>
                            <div className="flex gap-3"><button onClick={() => setIsSettingsOpen(true)} className="p-2 hover:bg-white/10 rounded-full"><Icons.Settings /></button><button onClick={handleReset} className="p-2 hover:bg-white/10 rounded-full"><Icons.Trash2 /></button><button type="button" onClick={handlePrint} className="p-2 bg-white text-primary rounded-full shadow-md"><Icons.Save /></button></div>
                        </div>
                    </nav>

                    <main className="max-w-md mx-auto p-4 print:max-w-none print:p-0">
                        <div className="print-only print-header">
                            <div className="flex items-start gap-4">
                                {state.settings.logo ? (
                                    <img src={state.settings.logo} className="h-16 object-contain max-w-[200px]" alt="Logo" />
                                ) : (
                                    <div><div className="text-xl font-black text-primary uppercase">{state.settings?.companyName || "MRS. SPARKLE"}</div></div>
                                )}
                                {!state.settings.logo && <div className="text-[10px] font-bold text-slate-500 uppercase mt-1 tracking-widest">{state.settings.docType || 'Quotation & Assessment'}</div>}
                            </div>
                            <div className="text-right text-[10px]">
                                {state.settings.logo && <div className="font-bold text-slate-500 uppercase tracking-widest text-xs mb-1">{state.settings.docType || 'Quotation'}</div>}
                                <div><b>Date:</b> {new Date().toLocaleDateString()}</div>
                            </div>
                        </div>

                        <Card className="page-break border-t-4 border-t-primary">
                            <CardHeader title="Client Details" icon={<Icons.User />} />
                            <div className="p-5 space-y-4 card-content">
                                <InputGroup label="Name" value={state.customer.name} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { name: e.target.value }})} />
                                <InputGroup label="Address" value={state.customer.address} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { address: e.target.value }})} />
                                <div className="grid grid-cols-2 gap-4 print-grid-2"><InputGroup label="Contact" value={state.customer.contact} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { contact: e.target.value }})} /><InputGroup label="Email" value={state.customer.email} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { email: e.target.value }})} /></div>
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 mt-2 grid grid-cols-2 gap-4 print:bg-transparent print:border-0 print:p-0 print-grid-2"><InputGroup label="Appt Date" type="datetime-local" value={state.customer.apptDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { apptDate: e.target.value }})} /><InputGroup label="Collection" type="date" value={state.customer.collectionDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { collectionDate: e.target.value }})} /><div className="col-span-2 print:col-span-2"><InputGroup label="Clean / Install" type="date" value={state.customer.cleanDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { cleanDate: e.target.value }})} /></div></div>
                            </div>
                        </Card>

                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex overflow-hidden mb-5 tab-nav-bar">
                            <TabButton label="Curtains" icon={<Icons.Layers />} isActive={activeTab === 'curtains'} onClick={() => setActiveTab('curtains')} />
                            <TabButton label="Cleaning" icon={<Icons.AppWindow />} isActive={activeTab === 'cleaning'} onClick={() => setActiveTab('cleaning')} />
                            <TabButton label="Handyman" icon={<Icons.Hammer />} isActive={activeTab === 'handyman'} onClick={() => setActiveTab('handyman')} />
                            <TabButton label="Summary" icon={<Icons.Calculator />} isActive={activeTab === 'summary'} onClick={() => setActiveTab('summary')} />
                        </div>

                        <div className={`tab-content ${activeTab === 'curtains' ? 'block' : 'hidden'}`}>
                            <SectionTitle title="Room Assessment" />
                            <div className="space-y-5">
                                {state.rooms.map((room) => <RoomCard key={room.id} room={room} dispatch={dispatch} />)}
                                <button onClick={() => { const name = prompt("Enter Room Name:"); if (name) dispatch({ type: 'ADD_ROOM', payload: name }); }} className="w-full py-4 border-2 border-dashed border-primary/40 text-primary rounded-xl flex items-center justify-center gap-2 font-bold uppercase text-sm hover:bg-primaryLight no-print"><Icons.Plus /> Add Room</button>
                            </div>
                        </div>

                        <div className={`tab-content ${activeTab === 'cleaning' ? 'block' : 'hidden'} ${isCleaningEmpty ? 'print-hidden-section' : ''}`}>
                            <SectionTitle title="Additional Info" />
                            <Card className="page-break">
                                <CardHeader title="Site Condition" icon={<Icons.AppWindow />} />
                                <div className="p-5 card-content">
                                    <div className="grid grid-cols-2 gap-4 no-print">
                                        <InputGroup labelClass={boldLabelClass} label="Bedroom" type="number" value={state.services.bedroomsCount} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { bedroomsCount: e.target.value }})} />
                                        <InputGroup labelClass={boldLabelClass} label="Bathroom" type="number" value={state.services.bathroomsCount} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { bathroomsCount: e.target.value }})} />
                                        <InputGroup labelClass={boldLabelClass} label="Blinds" value={state.services.rollerBlinds} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { rollerBlinds: e.target.value }})} />
                                        <InputGroup labelClass={boldLabelClass} label="Mosquito-nets" type="number" value={state.services.mosquitoNets} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { mosquitoNets: e.target.value }})} />
                                        <InputGroup labelClass={boldLabelClass} label="Kitchen" value={state.services.kitchenCondition} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { kitchenCondition: e.target.value }})} />
                                        <InputGroup labelClass={boldLabelClass} label="Cupboards" value={state.services.cupboards} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { cupboards: e.target.value }})} />
                                        <InputGroup labelClass={boldLabelClass} label="Balconies" type="number" value={state.services.balconies} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { balconies: e.target.value }})} />
                                    </div>
                                    <div className="print-only flex flex-col gap-1">
                                        <div className="grid grid-cols-2 gap-x-8 gap-y-1">
                                            <PrintItem label="Bedroom" value={state.services.bedroomsCount} />
                                            <PrintItem label="Bathroom" value={state.services.bathroomsCount} />
                                            <PrintItem label="Blinds" value={state.services.rollerBlinds} />
                                            <PrintItem label="Mosquito-nets" value={state.services.mosquitoNets} />
                                            <PrintItem label="Kitchen" value={state.services.kitchenCondition} />
                                            <PrintItem label="Cupboards" value={state.services.cupboards} />
                                            <PrintItem label="Balconies" value={state.services.balconies} />
                                        </div>
                                    </div>
                                    <div className="bg-slate-100 p-4 rounded-xl border border-slate-200 mt-4 print:bg-transparent print:border-0 print:p-0">
                                        <div className="grid grid-cols-2 gap-4 print:block mb-4">
                                            <div className="no-print"><InputGroup label="Cleaners" type="number" step="0.5" value={state.services.neededCleaners} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { neededCleaners: e.target.value }})} /></div>
                                            <div className="print-only mb-4 mt-2"><div className="border-2 border-slate-200 rounded-lg p-2 flex justify-between items-center bg-slate-50"><span className="text-xs font-black text-slate-500 uppercase">Manpower</span><span className="text-sm font-black text-slate-800">{state.services.neededCleaners ? `${state.services.neededCleaners} Cleaners` : '0 Cleaners'}</span></div></div>
                                            <div className="flex justify-between items-center border-t border-slate-300 pt-2 print:border-t print:border-slate-800"><label className="block text-xs font-black text-slate-600 uppercase">Est. Cleaning Cost</label><span className="text-lg font-bold text-slate-800">${cleaningAmount.toFixed(2)}</span></div>
                                        </div>
                                        <div className={!state.services.others ? 'print-hidden-section' : ''}>
                                            <label className="block text-xs font-bold text-slate-600 uppercase mb-2 ml-1 no-print">Inspector Notes</label>
                                            <label className="block text-xs font-black text-slate-800 uppercase mb-1 print-only">Inspector Notes</label>
                                            <textarea rows="4" className="w-full px-4 py-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary bg-white no-print" value={state.services.others} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { others: e.target.value }})}></textarea>
                                            {/* Preview on Screen and Print */}
                                            <div className="mt-1"><FormattedNote text={state.services.others} /></div>
                                        </div>
                                    </div>
                                </div>
                            </Card>
                        </div>

                        <div className={`tab-content ${activeTab === 'handyman' ? 'block' : 'hidden'} ${isHandymanEmpty ? 'print-hidden-section' : ''}`}>
                            <SectionTitle title="Handyman" />
                            <Card className="page-break">
                                <CardHeader title="Handyman Services" icon={<Icons.Hammer />} />
                                <div className="p-5 space-y-4 card-content">
                                    <div className="w-1/2 pr-2 no-print"><InputGroup label="Patch Holes" value={state.services.patchHoles} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { patchHoles: e.target.value }})} /></div>
                                    <div className="print-only"><PrintItem label="Patch Holes" value={state.services.patchHoles} /></div>
                                    <div className={!state.services.handymanNotes ? 'print-hidden-section' : ''}>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2 no-print">Description</label>
                                        <textarea rows="6" className="w-full px-4 py-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary bg-slate-50 no-print" value={state.services.handymanNotes} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { handymanNotes: e.target.value }})}></textarea>
                                        {/* Preview on Screen and Print */}
                                        <div className="mt-1"><FormattedNote text={state.services.handymanNotes} /></div>
                                    </div>
                                </div>
                            </Card>
                        </div>

                        <div className={`tab-content ${activeTab === 'summary' ? 'block' : 'hidden'}`}>
                            <SectionTitle title="Quotation" />
                            <Card className="bg-gradient-to-br from-white to-slate-50 border-primary/20 page-break shadow-md">
                                <CardHeader title="Summary" icon={<Icons.Calculator />} />
                                <div className="p-5 card-content">
                                    <div className="flex justify-between items-center mb-6 pb-6 border-b border-slate-200 print:mb-3 print:pb-3"><span className="font-bold text-slate-500 uppercase text-xs tracking-wider">Total Curtain Qty</span><span className="text-3xl font-bold text-slate-700 print:text-xl">{totalPieces} <span className="text-sm font-normal text-slate-400">pcs</span></span></div>
                                    <div className="mb-4"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Curtains Price ($)</label><input type="text" value={curtainAmount.toFixed(2)} disabled className="w-full text-right text-2xl font-bold text-slate-700 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 print:text-xl print:bg-transparent print:border-0" /></div>
                                    {cleaningAmount > 0 && (<div className="mb-4"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Cleaning & Services ($)</label><input type="text" value={cleaningAmount.toFixed(2)} disabled className="w-full text-right text-2xl font-bold text-slate-700 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 print:text-xl print:bg-transparent print:border-0" /></div>)}
                                    <div className="bg-primaryLight p-4 rounded-xl border border-primary/20 print:bg-transparent print:border-0 print:p-0"><label className="block text-xs font-bold text-primaryDark uppercase mb-1">Grand Total ($)</label><input type="text" value={totalAmount.toFixed(2)} readOnly className="w-full text-right text-3xl font-bold text-primary bg-transparent outline-none print:text-2xl" /></div>
                                </div>
                            </Card>
                        </div>

                        <div className="print-only print-footer">
                            <div className="flex justify-end">
                                <div className="text-center"><div className="border-b border-black w-32 mb-1"></div><div className="font-bold uppercase text-[9px]">Signature</div></div>
                            </div>
                        </div>

                        <div className="text-center mt-8 no-print text-slate-400 text-xs">© Site Assessment V25 (Pro)</div>
                    </main>
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} priceList={priceList} setPriceList={setPriceList} settings={state.settings} dispatch={dispatch} showToast={showToast} />
                </div>
            );
        }

        function SettingsModal({ isOpen, onClose, priceList, setPriceList, settings, dispatch, showToast }) {
            const dialogRef = useRef(null);
            useEffect(() => { if (isOpen) dialogRef.current?.showModal(); else dialogRef.current?.close(); }, [isOpen]);
            const handleChange = (key, val) => setPriceList(prev => ({ ...prev, [key]: val }));
            const handleSettingChange = (key, val) => dispatch({ type: 'SET_SETTINGS', payload: { [key]: val } });
            
            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if(file){
                    if(file.size > 800000) { alert("File too large! Please use image under 800KB."); return; }
                    const reader = new FileReader();
                    reader.onloadend = () => { handleSettingChange('logo', reader.result); showToast("Logo uploaded!"); };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <dialog ref={dialogRef} onClose={onClose} className="w-full max-w-md p-0 no-print">
                    <div className="flex flex-col h-[80vh]">
                        <div className="flex justify-between items-center p-4 border-b border-slate-200"><h3 className="text-lg font-bold text-slate-800">Settings</h3><button onClick={onClose}><Icons.X /></button></div>
                        <div className="p-6 space-y-6 bg-slate-50 overflow-y-auto flex-1">
                            
                            <div className="space-y-3">
                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Document Settings</h4>
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-600 mb-1">Doc Type</label>
                                        <select value={settings.docType || 'Quotation'} onChange={e => handleSettingChange('docType', e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm bg-white">
                                            <option>Quotation</option><option>Invoice</option><option>Receipt</option><option>Assessment</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-600 mb-1">Company Logo</label>
                                        <label className="flex items-center justify-center w-full px-3 py-2 border border-dashed border-primary text-primary rounded-lg text-xs font-bold cursor-pointer hover:bg-primaryLight">
                                            <Icons.Upload /> <span className="ml-2">{settings.logo ? "Change Logo" : "Upload"}</span>
                                            <input type="file" accept="image/*" onChange={handleLogoUpload} className="hidden" />
                                        </label>
                                    </div>
                                </div>
                                {settings.logo && <div className="text-center"><img src={settings.logo} className="h-16 mx-auto object-contain border rounded p-1" /><button onClick={() => handleSettingChange('logo', null)} className="text-xs text-red-500 underline mt-1">Remove Logo</button></div>}
                            </div>

                            <div className="space-y-3 border-t pt-4">
                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">App Theme</h4>
                                <div className="flex flex-wrap gap-3">
                                    {Object.entries(themes).map(([key, theme]) => (
                                        <button key={key} onClick={() => handleSettingChange('theme', key)} 
                                            className={`w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all ${settings.theme === key ? 'border-slate-800 scale-110 shadow-md' : 'border-white ring-1 ring-slate-200'}`}
                                            style={{backgroundColor: theme.primary}} title={theme.name}>
                                            {settings.theme === key && <svg className="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="space-y-3 border-t pt-4">
                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Company Details</h4>
                                <InputGroup label="Company Name" value={settings?.companyName} onChange={e => handleSettingChange('companyName', e.target.value)} />
                                <div className="mb-3"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Bank / Payment Info</label><textarea rows="3" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm" value={settings?.bankInfo} onChange={e => handleSettingChange('bankInfo', e.target.value)}></textarea></div>
                            </div>
                            <div className="space-y-3 border-t pt-4">
                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Price List</h4>
                                {curtainTypes.map(t => (<div key={t} className="flex items-center gap-2"><label className="w-1/2 text-sm font-medium">{t}</label><input type="number" value={priceList[t] || ''} onChange={e => handleChange(t, e.target.value)} className="w-1/2 px-3 py-2 border rounded-lg text-sm" /></div>))}
                                <div className="flex items-center gap-2"><label className="w-1/2 text-sm font-medium">Cleaner Rate</label><input type="number" value={priceList['pricePerCleaner'] || ''} onChange={e => handleChange('pricePerCleaner', e.target.value)} className="w-1/2 px-3 py-2 border rounded-lg text-sm" /></div>
                                <div className="flex items-center gap-2"><label className="w-1/2 text-sm font-medium">Supplies Fee</label><input type="number" value={priceList['cleaningSuppliesPrice'] || ''} onChange={e => handleChange('cleaningSuppliesPrice', e.target.value)} className="w-1/2 px-3 py-2 border rounded-lg text-sm" /></div>
                            </div>
                        </div>
                        <div className="p-4 bg-slate-100 border-t text-right"><button onClick={onClose} className="bg-primary text-white px-5 py-2 rounded-lg font-semibold text-sm">Save & Close</button></div>
                    </div>
                </dialog>
            );
        }

        function RoomCard({ room, dispatch }) {
            const [isExpanded, setIsExpanded] = useState(true);
            const total = useMemo(() => Object.values(room.curtains).reduce((sum, data) => { if (Array.isArray(data)) { return sum + data.reduce((arrSum, item) => arrSum + (parseInt(item.qty) || 0), 0); } else { return sum + (parseInt(data?.qty) || 0); } }, 0), [room.curtains]);
            const [showRoman, setShowRoman] = useState(false);
            const hasRomanData = (room.curtains['Roman Blinds']?.qty > 0 || room.curtains['Roman Blinds']?.romanDims?.length || room.curtains['Roman Blinds']?.romanDims?.height);
            useEffect(() => { if (hasRomanData) setShowRoman(true); }, [hasRomanData]);
            const ChevronDown = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" /></svg>;
            const ChevronUp = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clipRule="evenodd" /></svg>;

            return (
                <div className={total === 0 ? "print-hidden-section" : ""}>
                    <Card className="page-break transition-all hover:shadow-md">
                        <div onClick={() => setIsExpanded(!isExpanded)} className="bg-white px-4 py-3 border-b border-slate-100 flex justify-between items-center card-header cursor-pointer select-none">
                            <div className="flex items-center gap-2"><div className="text-slate-400 no-print">{isExpanded ? <ChevronUp/> : <ChevronDown/>}</div><span className="font-bold text-slate-700 text-lg">{room.name}</span></div>
                            <div className="flex items-center gap-3"><span className={`text-xs font-bold px-2.5 py-1 rounded-full border no-print ${total > 0 ? 'bg-primaryLight text-primary border-teal-100' : 'bg-slate-100 text-slate-400 border-slate-200'}`}>{total} pcs</span><button onClick={(e) => { e.stopPropagation(); if(confirm("Delete room?")) dispatch({ type: 'DELETE_ROOM', payload: room.id }); }} className="text-slate-300 hover:text-red-500 no-print p-1 hover:bg-slate-50 rounded"><Icons.X /></button></div>
                        </div>
                        <div className={`p-3 bg-white card-content ${isExpanded ? 'block' : 'hidden print:block'}`}>
                            <div className="mb-2 pb-1 border-b border-slate-200 curtain-print-row flex items-center justify-between">
                                <div className="w-auto max-w-[35%] sm:w-1/3 curtain-print-left"><span className="text-xs font-black text-black uppercase">Item</span></div>
                                <div className="flex items-center justify-end gap-2 flex-1 curtain-print-right"><div className="print-pleats-col flex items-center justify-center w-16 mr-2 print:mr-0"><span className="text-xs font-black text-black uppercase text-center print-pleats-input">Pleats/Dim</span></div><div className="print-qty-col flex items-center justify-center gap-1 w-24 print:w-auto"><span className="text-xs font-black text-black uppercase text-center w-full print-qty-input">Qty</span></div><div className="w-6 no-print"></div></div>
                            </div>
                            {curtainTypes.map(type => {
                                if (type === 'Roman Blinds' && !showRoman) return null;
                                if (pleatTypes.includes(type)) {
                                    return (<div key={type} className={`py-1 ${room.curtains[type].every(i=>!parseInt(i.qty)) ? 'print-hidden-section' : ''}`}>{room.curtains[type].map((item, idx) => <CurtainInput key={item.id} label={type} data={item} onChange={d => dispatch({ type: 'UPDATE_PLEAT_ITEM', payload: { roomId: room.id, type, itemId: item.id, newData: d } })} onDelete={() => dispatch({ type: 'DELETE_PLEAT_ITEM', payload: { roomId: room.id, type, itemId: item.id } })} isPleatType={true} showLabel={idx === 0} canDelete={room.curtains[type].length > 1} />)}<div className="flex justify-end mt-1 mb-2 pr-2 no-print"><button onClick={() => dispatch({ type: 'ADD_PLEAT_ITEM', payload: { roomId: room.id, type } })} className="flex items-center gap-1 text-xs text-primary font-bold opacity-70 hover:opacity-100">+ Add {type}</button></div></div>);
                                } else { return <CurtainInput key={type} label={type} data={room.curtains[type]} onChange={d => dispatch({ type: 'UPDATE_SINGLE_CURTAIN_DATA', payload: { id: room.id, type, newData: d } })} onDelete={() => { if(type === 'Roman Blinds') { setShowRoman(false); dispatch({ type: 'UPDATE_SINGLE_CURTAIN_DATA', payload: { id: room.id, type, newData: { qty: 0, pleats: '', romanDims: {length:'', height:'', unit:'cm'} } } }); } }} isPleatType={false} showLabel={true} canDelete={type === 'Roman Blinds'} />; }
                            })}
                            {!showRoman && <div className="flex justify-end mt-2 pr-2 no-print"><button onClick={() => setShowRoman(true)} className="flex items-center gap-1 text-xs text-primary font-bold border border-primary/30 rounded-full px-3 py-1 hover:bg-primaryLight">+ Add Roman Blinds</button></div>}
                        </div>
                    </Card>
                </div>
            );
        }

        function CurtainInput({ label, data, onChange, onDelete, isPleatType, showLabel, canDelete }) {
            const isRoman = label === 'Roman Blinds'; const isBelt = label === 'Belts';
            const romanDims = data.romanDims || { length: '', height: '', unit: 'cm' };
            const qty = parseInt(data.qty) || 0;
            const screenClass = `flex items-center justify-between py-3 border-b border-slate-100 last:border-0 ${qty === 0 && !isPleatType ? 'print-hidden-section' : ''}`;
            
            return (
                <div className={`${screenClass} curtain-print-row`}>
                    <div className="flex items-center gap-2 w-auto max-w-[35%] sm:w-1/3 curtain-print-left">{showLabel ? <span className={`text-sm font-medium truncate ${isRoman || isPleatType ? 'text-primaryDark font-bold' : 'text-slate-700'}`}>{label}</span> : <div className="w-4"></div>}</div>
                    <div className="flex items-center justify-end gap-2 flex-1 curtain-print-right">
                        <div className={`print-pleats-col flex items-center justify-center gap-1 w-16 mr-2 ${!isPleatType && !isRoman && !isBelt ? 'invisible' : ''} print:mr-0`}>
                            {isRoman && (<div className="w-full flex justify-center"><div className="flex flex-col gap-1 w-[120px] -ml-12 no-print"><div className="flex items-center gap-1"><input type="number" value={romanDims.length} onChange={e => onChange({ ...data, romanDims: { ...romanDims, length: e.target.value } })} placeholder="L" className="w-full px-1 py-1 border border-slate-200 rounded text-xs text-center bg-slate-50 focus:bg-white" /><span className="text-slate-400 text-[9px]">x</span><input type="number" value={romanDims.height} onChange={e => onChange({ ...data, romanDims: { ...romanDims, height: e.target.value } })} placeholder="H" className="w-full px-1 py-1 border border-slate-200 rounded text-xs text-center bg-slate-50 focus:bg-white" /></div><select value={romanDims.unit} onChange={e => onChange({ ...data, romanDims: { ...romanDims, unit: e.target.value } })} className="text-[10px] py-0 border border-slate-200 rounded bg-slate-100 w-full text-center h-5"><option value="cm">cm</option><option value="in">in</option><option value="ft">ft</option><option value="m">m</option></select></div><div className="print-only text-xs font-bold text-slate-700 whitespace-nowrap">{romanDims.length || 0} x {romanDims.height || 0} {romanDims.unit}</div></div>)}
                            {isPleatType && <div className="relative w-full"><input type="number" value={data.pleats || ''} onChange={e => onChange({ ...data, pleats: e.target.value })} placeholder="Plt" className="w-full px-1 py-1 text-center border border-slate-200 rounded text-sm bg-slate-50 focus:bg-white print-pleats-input" /></div>}
                            {isBelt && <div className="relative w-full"><input type="text" value="Pcs" disabled className="w-full px-1 py-1 text-center border bg-slate-50 text-slate-400 rounded text-xs" /></div>}
                        </div>
                        <div className="print-qty-col flex items-center justify-center gap-1 w-24 print:w-auto print:ml-0"><button onClick={() => onChange({ ...data, qty: Math.max(0, (data.qty || 0) - 1) })} className="w-7 h-7 flex items-center justify-center rounded bg-slate-100 text-slate-600 no-print hover:bg-slate-200">-</button><div className="w-8 text-center print:w-full"><input type="number" value={data.qty || 0} onChange={e => onChange({ ...data, qty: parseInt(e.target.value) || 0 })} className="w-full text-center py-1 border border-transparent rounded text-sm font-bold text-primaryDark print-qty-input focus:bg-white focus:border-slate-200" /></div><button onClick={() => onChange({ ...data, qty: (data.qty || 0) + 1 })} className="w-7 h-7 flex items-center justify-center rounded bg-primary text-white no-print hover:bg-primaryDark">+</button></div>
                        <div className="w-6 flex justify-center no-print">{(isPleatType && showLabel && canDelete) && <button onClick={onDelete} className="text-slate-300 hover:text-red-500"><Icons.X /></button>}{(isRoman) && <button onClick={onDelete} className="text-slate-300 hover:text-red-500"><Icons.X /></button>}{(!showLabel && canDelete && isPleatType) && <button onClick={onDelete} className="text-slate-300 hover:text-red-500"><Icons.X /></button>}</div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
