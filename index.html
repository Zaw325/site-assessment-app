<script type="text/babel">
    
    const { useState, useEffect, useReducer, useCallback, useMemo } = React;

    // --- (Utility Functions & Components) ---

    // LocalStorage Keys
    const DATA_KEY = 'siteAssessmentData_v15';
    const PRICE_KEY = 'siteAssessmentPrices_v15';

    // Helper: Load state from LocalStorage
    const loadState = (key, defaultState) => {
        try {
            const storedValue = localStorage.getItem(key);
            if (storedValue) return JSON.parse(storedValue);
        } catch (e) { console.error("Failed to parse state from localStorage", e); }
        return defaultState;
    };

    // --- (UNCHANGED) Icon Components ---
    const Icon = ({ children, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            {children}
        </svg>
    );
    const Icons = {
        Save: () => <Icon><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></Icon>,
        Trash2: () => <Icon><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>,
        Plus: () => <Icon><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>,
        User: () => <Icon><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></Icon>,
        Calculator: () => <Icon><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line></Icon>,
        CheckSquare: () => <Icon><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></Icon>,
        AppWindow: () => <Icon><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="M10 4v4"></path><path d="M2 8h20"></path><path d="M6 4v4"></path></Icon>,
        X: () => <Icon><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>,
        Settings: () => <Icon><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></Icon>,
        DollarSign: () => <Icon><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></Icon>
    };

    // --- (Utility Components - FormattedNote is NOW CORRECTED) ---
    const FormattedNote = ({ text }) => {
        if (!text) return null;
        const parts = text.split(/(\*[^*]+\*|#[^#]+#)/g);
        return (
            <div className="formatted-note-view text-sm font-mono bg-white">
                {parts.map((part, index) => {
                    if (part.startsWith('*') && part.endsWith('*')) {
                        return <span key={index} className="text-yellow-custom">{part.slice(1, -1)}</span>;
                    } else if (part.startsWith('#') && part.endsWith('#')) {
                        return <span key={index} className="text-red-custom">{part.slice(1, -1)}</span>;
                    } else {
                        return <span key={index}>{part}</span>;
                    }
                })}
            </div>
        );
    };
    const Card = ({ children, className = "" }) => ( <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4 ${className}`}>{children}</div> );
    const CardHeader = ({ title, icon, rightElement }) => ( <div className="bg-primaryLight px-4 py-3 border-b border-teal-100 flex items-center justify-between"> <div className="flex items-center gap-2"> <span className="text-primary">{icon}</span> <h3 className="font-bold text-primaryDark tracking-wide text-sm uppercase">{title}</h3> </div> {rightElement} </div> );
    const SectionTitle = ({ title }) => ( <div className="flex items-center gap-2 mt-8 mb-3 px-1"> <div className="h-px bg-slate-300 flex-1"></div> <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest">{title}</h4> <div className="h-px bg-slate-300 flex-1"></div> </div> );
    const InputGroup = ({ label, value, onChange, type = "text", placeholder = "", className = "", disabled=false, step=null }) => ( <div className={`mb-3 ${className}`}> <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{label}</label> <input type={type} value={value} onChange={onChange} placeholder={placeholder} step={step} className={`w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm transition-shadow ${disabled ? 'bg-slate-100 text-slate-500' : ''}`} disabled={disabled} /> </div> );

    // --- (Data State Management - V15 - MODIFIED) ---
    
    // Default state values
    const curtainTypes = ['Blackout', 'Day', 'Night', 'Roman Blinds', 'Belts'];

    // --- (NEW) Helper function to create a single new item ---
    const createNewCurtainItem = () => ({
        id: Date.now() + Math.random(), 
        pleats: '',
        qty: 0,
        romanDims: { length: '', height: '', unit: 'cm' }
    });

    // --- (MODIFIED) createEmptyCurtains now returns an object of ARRAYS ---
    const createEmptyCurtains = () => curtainTypes.reduce((acc, type) => ({
        ...acc,
        [type]: [ createNewCurtainItem() ] // Start with one item of each type
    }), {});
    
    const defaultState = {
        customer: { name: '', address: '', contact: '', email: '', apptDate: '', collectionDate: '', cleanDate: '' },
        services: { windows: '', kitchenCondition: '', bedroomsCount: '', bathroomsCount: '', cupboards: '', others: '', neededCleaners: '' },
        rooms: [
            { id: 1, name: 'Living Rm', curtains: createEmptyCurtains() },
            { id: 2, name: 'Dining Rm', curtains: createEmptyCurtains() },
            { id: 3, name: 'Master Bedroom', curtains: createEmptyCurtains() },
            { id: 4, name: 'Guest Rm', curtains: createEmptyCurtains() }
        ]
    };
    
    // Price list is unchanged
    const defaultPrices = {
        Blackout: '1', Day: '1', Night: '1', 'Roman Blinds': '15', Belts: '2', 
        pricePerCleaner: '50', cleaningSuppliesPrice: '0'
    };
    const PRICE_UNITS = {
        'Blackout': '(per pleat)', 'Day': '(per pleat)', 'Night': '(per pleat)', 
        'Roman Blinds': '(per sq/m)', 'Belts': '(per piece)', 
        'pricePerCleaner': '(per cleaner)', 'cleaningSuppliesPrice': '(fixed fee)'
    };

    // --- (MODIFIED) Reducer function to handle new data structure ---
    function appReducer(state, action) {
        switch (action.type) {
            case 'SET_CUSTOMER': return { ...state, customer: { ...state.customer, ...action.payload } };
            case 'SET_SERVICES': return { ...state, services: { ...state.services, ...action.payload } };
            case 'ADD_ROOM': return { ...state, rooms: [...state.rooms, { id: Date.now(), name: action.payload, curtains: createEmptyCurtains() }] };
            case 'DELETE_ROOM': return { ...state, rooms: state.rooms.filter(r => r.id !== action.payload) };
            
            // --- (NEW) Action to add a new item (e.g., a second "Blackout") ---
            case 'ADD_CURTAIN_ITEM': {
                const { roomId, type } = action.payload;
                return {
                    ...state,
                    rooms: state.rooms.map(room => 
                        room.id === roomId ? {
                            ...room,
                            curtains: {
                                ...room.curtains,
                                [type]: [ ...room.curtains[type], createNewCurtainItem() ]
                            }
                        } : room
                    )
                };
            }

            // --- (NEW) Action to delete a specific item (e.g., the second "Blackout") ---
            case 'DELETE_CURTAIN_ITEM': {
                const { roomId, type, itemId } = action.payload;
                return {
                    ...state,
                    rooms: state.rooms.map(room =>
                        room.id === roomId ? {
                            ...room,
                            curtains: {
                                ...room.curtains,
                                [type]: room.curtains[type].filter(item => item.id !== itemId)
                            }
                        } : room
                    )
                };
            }

            // --- (NEW) Action to update a specific item ---
            case 'UPDATE_CURTAIN_ITEM': {
                const { roomId, type, itemId, newData } = action.payload;
                return {
                    ...state,
                    rooms: state.rooms.map(room =>
                        room.id === roomId ? {
                            ...room,
                            curtains: {
                                ...room.curtains,
                                [type]: room.curtains[type].map(item =>
                                    item.id === itemId ? { ...item, ...newData } : item
                                )
                            }
                        } : room
                    )
                };
            }
                
            case 'RESET': return defaultState;
            default: return state;
        }
    }

    // --- (Main App Component - V15 - MODIFIED) ---
    function App() {
        const [state, dispatch] = useReducer(appReducer, loadState(DATA_KEY, defaultState));
        const [priceList, setPriceList] = useState(() => loadState(PRICE_KEY, defaultPrices));
        
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [totalAmount, setTotalAmount] = useState(0); 
        const [cleaningAmount, setCleaningAmount] = useState(0); 

        // Auto-Save Data (No Change)
        useEffect(() => {
            const handler = setTimeout(() => {
                localStorage.setItem(DATA_KEY, JSON.stringify(state));
                console.log("Auto-saved data.");
            }, 3000); 
            return () => clearTimeout(handler);
        }, [state]);

        // Auto-Save Prices (No Change)
        useEffect(() => {
            localStorage.setItem(PRICE_KEY, JSON.stringify(priceList));
        }, [priceList]);

        // --- (MODIFIED) Calculation logic for GRAND TOTAL ---
        useEffect(() => {
            let curtainTotal = 0;
            const prices = priceList;

            // 1. Calculate Curtain Total (MODIFIED with nested loop)
            state.rooms.forEach(room => {
                // Loop over types (Blackout, Day, etc.)
                Object.entries(room.curtains).forEach(([type, itemsArray]) => {
                    const price = parseFloat(prices[type]) || 0;
                    
                    // Loop over items *within* that type (e.g., all "Blackout" items)
                    itemsArray.forEach(item => { 
                        const qty = parseInt(item.qty) || 0;
                        if (qty === 0) return;

                        if (type === 'Roman Blinds') {
                            const dims = item.romanDims || {};
                            let length = parseFloat(dims.length) || 0;
                            let height = parseFloat(dims.height) || 0;
                            if (dims.unit === 'cm') { length = length / 100; height = height / 100; }
                            const area = length * height;
                            curtainTotal += area * price * qty;
                        } else if (type === 'Belts') {
                            curtainTotal += qty * price;
                        } else {
                            const pleats = parseInt(item.pleats) || 0;
                            curtainTotal += pleats * qty * price;
                        }
                    });
                });
            });

            // 2. Calculate Cleaning Total (No Change)
            const cleaners = parseFloat(state.services.neededCleaners) || 0;
            const pricePer = parseFloat(prices.pricePerCleaner) || 0;
            const suppliesPrice = parseFloat(prices.cleaningSuppliesPrice) || 0; 
            const newCleaningTotal = (cleaners * pricePer) + suppliesPrice;
            
            // 3. Set states (No Change)
            setCleaningAmount(newCleaningTotal);
            setTotalAmount(curtainTotal + newCleaningTotal);
            
        }, [state.rooms, state.services.neededCleaners, priceList]);

        // Handle Print/Reset (No Change)
        const handlePrint = () => window.print();
        const handleReset = () => {
            if(confirm("Reset Form? This will clear all data and prices.")) {
                dispatch({ type: 'RESET' });
                setPriceList(defaultPrices);
                localStorage.removeItem(DATA_KEY);
                localStorage.removeItem(PRICE_KEY);
                window.location.reload(); 
            }
        };
        
        // --- (MODIFIED) totalPieces calculation ---
        const totalPieces = useMemo(() => 
            state.rooms.reduce((total, room) => 
                total + Object.values(room.curtains).reduce((typeSum, itemsArray) => 
                    typeSum + itemsArray.reduce((itemSum, item) => 
                        itemSum + (parseInt(item.qty) || 0)
                    , 0)
                , 0)
            , 0)
        , [state.rooms]);

        return (
            <div className="min-h-screen pb-24 bg-slate-50">
                {/* --- (Navigation Bar - No Change) --- */}
                <nav className="bg-primary text-white px-4 py-3 shadow-lg sticky top-0 z-50 no-print backdrop-blur-sm bg-opacity-95">
                    <div className="max-w-md mx-auto flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="p-1.5 bg-white/20 rounded-lg"><Icons.CheckSquare /></div>
                            <span className="font-bold tracking-wide">SiteCheck V15</span>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-primaryLight hover:text-white hover:bg-white/10 rounded-full transition-all" title="Settings">
                                <Icons.Settings />
                            </button>
                            <button onClick={handleReset} className="p-2 text-primaryLight hover:text-white hover:bg-white/10 rounded-full transition-all" title="Reset Form"><Icons.Trash2 /></button>
                            <button onClick={handlePrint} className="p-2 bg-white text-primary rounded-full shadow-md hover:bg-primaryLight transition-all" title="Save/Print"><Icons.Save /></button>
                        </div>
                    </div>
                </nav>

                {/* --- (Main App Body - No Change) --- */}
                <main className="max-w-md mx-auto p-4 print:max-w-none print:p-0">
                    {/* --- (Client Details Card - No Change) --- */}
                    <Card className="page-break border-t-4 border-t-primary">
                        <CardHeader title="Client Details" icon={<Icons.User />} />
                        <div className="p-5 space-y-4">
                            <InputGroup label="Name" value={state.customer.name} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { name: e.target.value }})} placeholder="Full Name" />
                            <InputGroup label="Address" value={state.customer.address} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { address: e.target.value }})} placeholder="Unit, Street, Building" />
                            <div className="grid grid-cols-2 gap-4">
                                <InputGroup label="Contact" value={state.customer.contact} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { contact: e.target.value }})} type="tel" />
                                <InputGroup label="Email" value={state.customer.email} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { email: e.target.value }})} type="email" />
                            </div>
                            <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 mt-2 grid grid-cols-2 gap-4">
                                <InputGroup label="Appt Date" type="datetime-local" value={state.customer.apptDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { apptDate: e.target.value }})} />
                                <InputGroup label="Curtains Collection" type="date" value={state.customer.collectionDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { collectionDate: e.target.value }})} className="print:bg-yellow-50" />
                                <div className="col-span-2">
                                    <InputGroup label="Clean / Install Date" type="date" value={state.customer.cleanDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { cleanDate: e.target.value }})} />
                                </div>
                            </div>
                        </div>
                    </Card>

                    {/* --- (Room Assessment Section - No Change) --- */}
                    <SectionTitle title="Room Assessment" />
                    <div className="space-y-5">
                        {state.rooms.map((room) => (
                            <RoomCard key={room.id} room={room} dispatch={dispatch} />
                        ))}
                        <button onClick={() => { const name = prompt("Enter Room Name:"); if (name) dispatch({ type: 'ADD_ROOM', payload: name }); }}
                            className="w-full py-4 border-2 border-dashed border-primary/40 text-primary rounded-xl flex items-center justify-center gap-2 hover:bg-primaryLight hover:border-primary transition-all no-print font-bold uppercase tracking-wide text-sm">
                            <Icons.Plus /> Add New Room
                        </button>
                    </div>

                    {/* --- (Quotation Card - No Change) --- */}
                    <SectionTitle title="Quotation" />
                    <Card className="bg-gradient-to-br from-white to-slate-50 border-primary/20 page-break shadow-md">
                        <CardHeader title="Summary" icon={<Icons.Calculator />} />
                        <div className="p-5">
                            <div className="flex justify-between items-center mb-6 pb-6 border-b border-slate-200">
                                <span className="font-bold text-slate-500 uppercase text-xs tracking-wider">Total Curtain Qty</span>
                                <span className="text-3xl font-bold text-slate-700">{totalPieces} <span className="text-sm font-normal text-slate-400">pcs</span></span>
                            </div>
                            <div className="bg-primaryLight p-4 rounded-xl border border-primary/20">
                                <label className="block text-xs font-bold text-primaryDark uppercase mb-1">Grand Total Amount ($)</label>
                                <input 
                                    type="text" 
                                    placeholder="0.00" 
                                    value={totalAmount.toFixed(2)}
                                    readOnly 
                                    className="w-full text-right text-3xl font-bold text-primary bg-transparent outline-none placeholder-teal-200/50" 
                                />
                            </div>
                        </div>
                    </Card>

                    {/* --- (Site Condition Card - No Change) --- */}
                    <SectionTitle title="Additional Info" />
                    <Card className="page-break">
                        <CardHeader title="Site Condition" icon={<Icons.AppWindow />} />
                        <div className="p-5 space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <InputGroup label="No. of Windows" type="number" value={state.services.windows} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { windows: e.target.value }})} />
                                <InputGroup label="Kitchen Condition" value={state.services.kitchenCondition} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { kitchenCondition: e.target.value }})} />
                                <InputGroup label="Bedrooms" type="number" value={state.services.bedroomsCount} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { bedroomsCount: e.target.value }})} />
                                <InputGroup label="Bathrooms" type="number" value={state.services.bathroomsCount} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { bathroomsCount: e.target.value }})} />
                            </div>
                            <InputGroup label="Cupboards & Shelves" value={state.services.cupboards} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { cupboards: e.target.value }})} />
                            
                            <div className="pt-4 border-t border-slate-200 mt-2">
                                <div className="grid grid-cols-2 gap-4">
                                    <InputGroup 
                                        label="Needed Cleaners" 
                                        type="number" 
                                        step="0.5"
                                        value={state.services.neededCleaners} 
                                        onChange={e => dispatch({ type: 'SET_SERVICES', payload: { neededCleaners: e.target.value }})} 
                                        placeholder="e.g. 1.5"
                                    />
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Est. Cleaning Amount</label>
                                        <input 
                                            type="text" 
                                            value={`$${cleaningAmount.toFixed(2)}`} 
                                            readOnly 
                                            disabled
                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-100 text-slate-500 font-bold"
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Inspector Notes <span className="ml-2 text-[10px] font-normal text-slate-400 normal-case no-print">(*yellow*, #red#)</span></label>
                                <textarea rows="6" className="w-full px-4 py-3 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary bg-slate-50" value={state.services.others} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { others: e.target.value }})} placeholder="Enter special requirements..."></textarea>
                                <FormattedNote text={state.services.others} />
                            </div>
                        </div>
                    </Card>

                    {/* --- (Print Signature Footer - No Change) --- */}
                    <div className="hidden print:flex mt-12 pt-8 border-t-2 border-slate-200 page-break justify-between items-end">
                        <div className="text-center w-1/3"><div className="h-16 border-b border-slate-400 mb-2"></div><div className="text-xs font-bold text-slate-500 uppercase">Customer Signature</div></div>
                        <div className="text-center w-1/3"><div className="h-16 border-b border-slate-400 mb-2"></div><div className="text-xs font-bold text-slate-500 uppercase">Inspector Signature</div></div>
                    </div>
                    
                    <div className="text-center mt-8 no-print text-slate-400 text-xs">&copy; Site Assessment App V15</div>
                </main>
                
                {/* --- (Settings Modal - CORRECTED) --- */}
                <SettingsModal 
                    isOpen={isSettingsOpen} 
                    onClose={() => setIsSettingsOpen(false)}
                    priceList={priceList}
                    setPriceList={setPriceList}
                />
            </div>
        );
    }

    // --- (Child Components - V15 - MODIFIED) ---

    // --- (Settings Modal Component - "Services" typo is NOW CORRECTED) ---
    function SettingsModal({ isOpen, onClose, priceList, setPriceList }) {
        const dialogRef = React.useRef(null);

        useEffect(() => {
            if (isOpen) dialogRef.current?.showModal();
            else dialogRef.current?.close();
        }, [isOpen]);

        const handlePriceChange = (type, value) => {
            setPriceList(prev => ({ ...prev, [type]: value }));
        };

        return (
            <dialog ref={dialogRef} onClose={onClose} className="w-full max-w-md p-0 no-print">
                <div className="flex flex-col">
                    <div className="flex justify-between items-center p-4 border-b border-slate-200">
                        <div className="flex items-center gap-2">
                            <span className="text-primary"><Icons.DollarSign /></span>
                            <h3 className="text-lg font-bold text-slate-800">Price List</h3>
                        </div>
                        <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icons.X /></button>
                    </div>
                    <div className="p-6 space-y-4 bg-slate-50">
                        <p className="text-sm text-slate-600">Set default prices for auto-calculation.</p>
                        
                        {/* Curtain Prices */}
                        {curtainTypes.map(type => (
                            <div key={type} className="flex items-center gap-2">
                                <label className="w-1/2 text-sm font-medium text-slate-700">
                                    {type} <span className="text-xs text-slate-400 font-normal">{PRICE_UNITS[type]}</span>
                                </label>
                                <div className="relative w-1/2">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                                    <input 
                                        type="number"
                                        value={priceList[type] || ''}
                                        onChange={(e) => handlePriceChange(type, e.target.value)}
                                        className="w-full pl-7 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                    />
                                </div>
                            </div>
                        ))}
                        
                        {/* Cleaning Price Section */}
                        <div className="pt-4 border-t border-slate-200 mt-4 space-y-4">
                            {/* Cleaner Price */}
                            <div className="flex items-center gap-2">
                                <label className="w-1/2 text-sm font-medium text-slate-700">
                                    Cleaning Staff <span className="text-xs text-slate-400 font-normal">{PRICE_UNITS['pricePerCleaner']}</span>
                                </label>
                                <div className="relative w-1/2">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                                    <input 
                                        type="number"
                                        value={priceList['pricePerCleaner'] || ''}
                                        onChange={(e) => handlePriceChange('pricePerCleaner', e.target.value)}
                                        className="w-full pl-7 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                    />
                                </div>
                            </div>
                            
                            {/* NOTE: The "Services" typo that was here is now REMOVED. */}
                            
                            {/* Cleaning Supplies Price */}
                            <div className="flex items-center gap-2">
                                <label className="w-1/2 text-sm font-medium text-slate-700">
                                    Cleaning Supplies <span className="text-xs text-slate-400 font-normal">{PRICE_UNITS['cleaningSuppliesPrice']}</span>
                                </label>
                                <div className="relative w-1/2">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                                    <input 
                                        type="number"
                                        value={priceList['cleaningSuppliesPrice'] || ''}
                                        onChange={(e) => handlePriceChange('cleaningSuppliesPrice', e.target.value)}
                                        className="w-full pl-7 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                    />
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    <div className="p-4 bg-slate-100 border-t border-slate-200 text-right">
                        <button onClick={onClose} className="bg-primary text-white px-5 py-2 rounded-lg font-semibold text-sm hover:bg-primaryDark transition-colors">Done</button>
                    </div>
                </div>
            </dialog>
        );
    }

    // --- (MODIFIED) RoomCard Component ---
    function RoomCard({ room, dispatch }) {
        // --- (MODIFIED) `total` calculation to sum items in nested arrays ---
        const total = useMemo(() => 
            Object.values(room.curtains).reduce((totalForType, itemsArray) => 
                totalForType + itemsArray.reduce((sum, item) => sum + (parseInt(item.qty) || 0), 0)
            , 0)
        , [room.curtains]);

        const handleDelete = () => {
            if(confirm(`Delete room "${room.name}"?`)) {
                dispatch({ type: 'DELETE_ROOM', payload: room.id });
            }
        };

        return (
            <Card className="page-break transition-all hover:shadow-md">
                <div className="bg-white px-4 py-3 border-b border-slate-100 flex justify-between items-center">
                    <span className="font-bold text-slate-700 text-lg">{room.name}</span>
                    <div className="flex items-center gap-3">
                        <span className="text-xs font-bold px-2.5 py-1 rounded-full bg-primaryLight text-primary border border-teal-100">{total} pcs</span>
                        <button onClick={handleDelete} className="text-slate-300 hover:text-red-500 no-print transition-colors"><Icons.X /></button>
                    </div>
                </div>
                {/* --- (MODIFIED) Map to new CurtainTypeSection component --- */}
                <div className="p-3 bg-white">
                    {curtainTypes.map((type) => (
                        <CurtainTypeSection 
                            key={type} 
                            label={type} 
                            items={room.curtains[type]} // Pass the array of items
                            dispatch={dispatch}
                            roomId={room.id}
                        />
                    ))}
                </div>
            </Card>
        );
    }

    // --- (NEW) CurtainTypeSection Component ---
    // This component manages the "Add" button and the list of items for ONE type (e.g., "Blackout")
    function CurtainTypeSection({ label, items, dispatch, roomId }) {
        
        const handleAddItem = () => {
            dispatch({ type: 'ADD_CURTAIN_ITEM', payload: { roomId, type: label } });
        };

        // Only allow adding more for the types you requested
        const canAddMore = ['Blackout', 'Day', 'Night'].includes(label);

        return (
            <div className="py-3 border-b border-slate-100 last:border-0">
                {/* Render each item in the array (e.g., all "Blackout" items) */}
                {items.map((item, index) => (
                    <CurtainItemRow
                        key={item.id}
                        label={label}
                        item={item}
                        isFirstItem={index === 0} // To show the label only on the first item
                        onChange={(newData) => dispatch({
                            type: 'UPDATE_CURTAIN_ITEM',
                            payload: { roomId, type: label, itemId: item.id, newData }
                        })}
                        onDelete={() => dispatch({
                            type: 'DELETE_CURTAIN_ITEM',
                            payload: { roomId, type: label, itemId: item.id }
                        })}
                        // Only allow deleting if there's more than one item
                        canDelete={items.length > 1} 
                    />
                ))}
                
                {/* "Add" Button (as requested by user) */}
                {canAddMore && (
                    <div className="flex justify-end mt-2 pr-12">
                        <button 
                            onClick={handleAddItem} 
                            className="flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-primaryLight text-primary hover:bg-teal-100 active:bg-teal-200 no-print transition-colors"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Add
                        </button>
                    </div>
                )}
            </div>
        );
    }


    // --- (MODIFIED) Renamed CurtainInput to CurtainItemRow ---
    // This component now renders only ONE item row
    function CurtainItemRow({ label, item, isFirstItem, onChange, onDelete, canDelete }) {
        const isRomanBlind = label === 'Roman Blinds';
        const isBelt = label === 'Belts';
        const isPleatCurtain = !isRomanBlind && !isBelt; 

        // Simplified onChange handlers
        const handleQtyChange = (newQty) => onChange({ qty: Math.max(0, newQty) });
        const handlePleatChange = (e) => onChange({ pleats: e.target.value });
        
        const handleRomanChange = (field, val) => {
            const currentDims = item.romanDims || { length: '', height: '', unit: 'cm' };
            const newDims = { ...currentDims, [field]: val };
            onChange({ romanDims: newDims });
        };

        const romanDims = item.romanDims || { length: '', height: '', unit: 'cm' };

        return (
            // Add spacing if it's not the first item in the list
            <div className={!isFirstItem ? "mt-3 pt-3 border-t border-slate-100" : ""}>
                <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                    
                    {/* Label Area */}
                    <div className="flex items-center gap-2 w-full sm:w-1/3">
                       {/* Only show label for the first item */}
                       {isFirstItem ? (
                            <>
                                <span className={`text-sm font-medium ${isRomanBlind || isPleatCurtain ? 'text-primaryDark font-bold' : 'text-slate-700'}`}>{label}</span>
                                {isRomanBlind && <span className="text-[10px] bg-teal-100 text-teal-800 px-1 rounded no-print">L x H (sq/m)</span>}
                                {isPleatCurtain && <span className="text-[10px] bg-teal-100 text-teal-800 px-1 rounded no-print">Pleats</span>}
                            </>
                       ) : (
                           // Show a delete button for extra items
                            canDelete && (
                                <button onClick={onDelete} title="Delete this item" className="text-red-400 hover:text-red-600 no-print p-1 rounded-full -ml-1 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                           )
                       )}
                    </div>
                    
                    {/* Inputs (Pleats, Roman, or Belts) */}
                    <div className="flex items-center gap-2 w-full sm:w-2/3 justify-end">
                        <div className="flex-1">
                            {isRomanBlind && (
                                <div className="flex items-center gap-1">
                                    <input type="number" value={romanDims.length} onChange={(e) => handleRomanChange('length', e.target.value)} placeholder="Len" className="w-1/3 min-w-[50px] px-1 py-1 text-center border border-slate-300 rounded text-sm focus:border-primary outline-none" />
                                    <span className="text-slate-400 text-xs">x</span>
                                    <input type="number" value={romanDims.height} onChange={(e) => handleRomanChange('height', e.target.value)} placeholder="Hgt" className="w-1/3 min-w-[50px] px-1 py-1 text-center border border-slate-300 rounded text-sm focus:border-primary outline-none" />
                                    <select value={romanDims.unit} onChange={(e) => handleRomanChange('unit', e.target.value)} className="w-1/3 min-w-[50px] bg-slate-50 border border-slate-300 text-xs rounded px-1 py-1 outline-none focus:border-primary">
                                        <option value="cm">cm</option>
                                        <option value="m">m</option>
                                    </select>
                                </div>
                            )}
                            {isPleatCurtain && (
                                <div className="relative max-w-[120px]">
                                    <input type="number" value={item.pleats || ''} onChange={handlePleatChange} placeholder="Pleats No." className="w-full px-2 py-1 text-center border border-slate-300 rounded text-sm focus:border-primary outline-none" />
                                </div>
                            )}
                            {isBelt && (
                                <div className="relative max-w-[120px]">
                                    <input type="text" value="Per Piece" readOnly disabled className="w-full px-2 py-1 text-center border-slate-200 bg-slate-50 text-slate-400 rounded text-sm outline-none" />
                                </div>
                            )}
                        </div>
                        
                        {/* Pcs Counter (for all types) */}
                        <div className="flex items-center gap-1 ml-2">
                            <button onClick={() => handleQtyChange((item.qty || 0) - 1)} className="w-7 h-7 flex items-center justify-center rounded bg-slate-100 text-slate-600 hover:bg-slate-200 active:bg-slate-300 touch-manipulation no-print shadow-sm">-</button>
                            <div className="w-10 text-center">
                                <input type="number" value={item.qty || 0} onChange={(e) => handleQtyChange(parseInt(e.target.value) || 0)} className="w-full text-center py-1 border border-slate-300 rounded text-sm font-bold bg-white text-primaryDark" />
                            </div>
                            <button onClick={() => handleQtyChange((item.qty || 0) + 1)} className="w-7 h-7 flex items-center justify-center rounded bg-primary text-white hover:bg-primaryDark active:opacity-80 touch-manipulation no-print shadow-sm">+</button>
                        </div>
                    </div>
                </div>
            </div>
        );
    };
    
    // --- (End of React App Code) ---

    // V11 Function to start the app
    window.renderTheApp = () => {
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    };
    
</script>
