<!DOCTYPE html>
<html lang="en">
<link rel="manifest" href="manifest.json">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Assessment App V19 (Tabs)</title>

    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0d9488', primaryLight: '#f0fdfa', primaryDark: '#115e59', secondary: '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .text-yellow-custom { color: #d97706; font-weight: bold; background: #fef3c7; padding: 0 4px; border-radius: 2px; } 
        .text-red-custom { color: #dc2626; font-weight: bold; background: #fee2e2; padding: 0 4px; border-radius: 2px; }
        
        /* --- PRINT STYLES (The Magic Part) --- */
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding-bottom: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .page-break { break-inside: avoid; page-break-inside: avoid; }
            input, select { border: 1px solid #ccc !important; border-radius: 4px; background: white !important; color: black !important; }
            button { display: none !important; }
            textarea { display: none !important; }
            .formatted-note-view { display: block !important; border: 1px solid #cbd5e1; padding: 12px; min-height: 150px; border-radius: 6px; white-space: pre-wrap; }
            dialog { display: none !important; }
            
            /* CRITICAL: Force all tabs to show when printing */
            .tab-content { display: block !important; }
            /* Hide the tab navigation bar when printing */
            .tab-nav-bar { display: none !important; }
        }
        
        .formatted-note-view { display: none; } 
        dialog { border: none; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 0; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
        @keyframes shake {
            0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="login-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm mx-4">
            <div class="flex flex-col items-center mb-6">
                <div class="p-3 bg-primaryLight rounded-full mb-3"><svg class="w-6 h-6 text-primaryDark" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></div>
                <h3 class="text-lg font-bold text-slate-800">Password Required</h3>
                <p class="text-sm text-slate-500">Please enter password to unlock.</p>
            </div>
            <input type="password" id="password-input" placeholder="Enter password..." class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm transition-shadow text-center">
            <button id="unlock-button" class="w-full bg-primary text-white py-3 rounded-lg font-semibold mt-4 hover:bg-primaryDark transition-colors shadow-md">Unlock</button>
            <p id="error-msg" class="text-red-600 text-sm mt-3 text-center hidden font-medium"></p>
        </div>
    </div>

    <div id="app-container" class="hidden opacity-0 transition-opacity duration-500">
        <div id="root"></div>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const CORRECT_PASSWORD = 'clean'; 
            const loginOverlay = document.getElementById('login-overlay');
            const loginBox = loginOverlay.querySelector('div');
            const appContainer = document.getElementById('app-container');
            const unlockButton = document.getElementById('unlock-button');
            const passwordInput = document.getElementById('password-input');
            const errorMsg = document.getElementById('error-msg');
            const attemptLogin = () => {
                const pass = passwordInput.value.trim();
                if (pass === CORRECT_PASSWORD) {
                    loginOverlay.classList.add('opacity-0');
                    setTimeout(() => { loginOverlay.style.display = 'none'; }, 300); 
                    appContainer.classList.remove('hidden');
                    setTimeout(() => appContainer.classList.remove('opacity-0'), 50);
                    
                    try { 
                        window.renderTheApp(); 
                    } catch (e) {
                        console.error("--- REAL APP ERROR ---", e);
                        document.body.innerHTML = 
                            "<div style='padding: 20px; font-family: sans-serif;'>" +
                            "<h2 style='color: red;'>Error: App failed to start.</h2>" +
                            "<p>There is a problem with the app's internal code. Please show this message to the developer:</p>" +
                            "<pre style='background: #eee; padding: 10px; border-radius: 5px; border: 1px solid #ccc; word-wrap: break-word; white-space: pre-wrap;'>" +
                            e.toString() +
                            "</pre>" +
                            "</div>";
                    }

                } else {
                    errorMsg.textContent = 'Incorrect Password. Please try again.';
                    errorMsg.classList.remove('hidden');
                    passwordInput.value = '';
                    loginBox.classList.add('animate-shake');
                    setTimeout(() => { loginBox.classList.remove('animate-shake'); }, 500);
                }
            };
            unlockButton.onclick = attemptLogin;
            passwordInput.onkeyup = (e) => {
                errorMsg.classList.add('hidden');
                if (e.key === 'Enter') attemptLogin();
            };
        });
    </script>
    
    <script type="text/babel">
        
        const { useState, useEffect, useReducer, useCallback, useMemo } = React;

        // --- Utility Functions & Components ---
        const pleatTypes = ['Blackout', 'Day', 'Night'];
        const DATA_KEY = 'siteAssessmentData_v15';
        const PRICE_KEY = 'siteAssessmentPrices_v15';

        const loadState = (key, defaultState) => {
            try {
                const storedValue = localStorage.getItem(key);
                if (storedValue) return JSON.parse(storedValue);
            } catch (e) { console.error("Failed to parse state from localStorage", e); }
            return defaultState;
        };

        const Icon = ({ children, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            Save: () => <Icon><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></Icon>,
            Trash2: () => <Icon><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>,
            Plus: () => <Icon><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>,
            User: () => <Icon><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></Icon>,
            Calculator: () => <Icon><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line></Icon>,
            CheckSquare: () => <Icon><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></Icon>,
            AppWindow: () => <Icon><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="M10 4v4"></path><path d="M2 8h20"></path><path d="M6 4v4"></path></Icon>,
            X: () => <Icon><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>,
            Settings: () => <Icon><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></Icon>,
            DollarSign: () => <Icon><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></Icon>,
            MapPin: () => <Icon className="w-4 h-4"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></Icon>,
            Hammer: () => <Icon><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></Icon>,
            Layers: () => <Icon><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></Icon>
        };

        const FormattedNote = ({ text }) => {
            if (!text) return null;
            const parts = text.split(/(\*[^*]+\*|#[^#]+#)/g);
            return (
                <div className="formatted-note-view text-sm font-mono bg-white">
                    {parts.map((part, index) => {
                        if (part.startsWith('*') && part.endsWith('*')) {
                            return <span key={index} className="text-yellow-custom">{part.slice(1, -1)}</span>;
                        } else if (part.startsWith('#') && part.endsWith('#')) {
                            return <span key={index} className="text-red-custom">{part.slice(1, -1)}</span>;
                        } else {
                            return <span key={index}>{part}</span>;
                        }
                    })}
                </div>
            );
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4 ${className}`}>{children}</div>
        );
        const CardHeader = ({ title, icon, rightElement, onClick, className="" }) => (
            <div onClick={onClick} className={`bg-primaryLight px-4 py-3 border-b border-teal-100 flex items-center justify-between ${className}`}>
                <div className="flex items-center gap-2">
                    <span className="text-primary">{icon}</span>
                    <h3 className="font-bold text-primaryDark tracking-wide text-sm uppercase">{title}</h3>
                </div>
                {rightElement}
            </div>
        );
        const SectionTitle = ({ title }) => (
            <div className="flex items-center gap-2 mt-8 mb-3 px-1">
                <div className="h-px bg-slate-300 flex-1"></div>
                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest">{title}</h4>
                <div className="h-px bg-slate-300 flex-1"></div>
            </div>
        );
        const InputGroup = ({ label, value, onChange, type = "text", placeholder = "", className = "", disabled=false, step=null }) => (
            <div className={`mb-3 ${className}`}>
                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{label}</label>
                <input
                    type={type}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    step={step}
                    className={`w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm transition-shadow ${disabled ? 'bg-slate-100 text-slate-500' : ''}`}
                    disabled={disabled}
                />
            </div>
        );

        const TabButton = ({ label, icon, isActive, onClick }) => (
            <button 
                onClick={onClick}
                className={`flex-1 py-3 px-2 flex flex-col items-center justify-center gap-1 text-xs font-bold uppercase tracking-wide transition-all border-b-2 ${isActive ? 'border-primary text-primary bg-primaryLight' : 'border-transparent text-slate-400 hover:bg-slate-50'}`}
            >
                {icon}
                <span>{label}</span>
            </button>
        );

        // --- Data State ---
        const curtainTypes = ['Blackout', 'Day', 'Night', 'Roman Blinds', 'Belts'];
        const createEmptyCurtains = () => {
            const newCurtains = {};
            pleatTypes.forEach(type => { newCurtains[type] = [ { id: Date.now(), pleats: '', qty: 0 } ]; });
            newCurtains['Roman Blinds'] = { pleats: '', qty: 0, romanDims: { length: '', height: '', unit: 'cm' } };
            newCurtains['Belts'] = { pleats: '', qty: 0 };
            return newCurtains;
        };
        
        const defaultState = {
            customer: { name: '', address: '', contact: '', email: '', apptDate: '', collectionDate: '', cleanDate: '' },
            services: { 
                windows: '', kitchenCondition: '', bedroomsCount: '', bathroomsCount: '', cupboards: '', 
                rollerBlinds: '', mosquitoNets: '', balconies: '',
                others: '', neededCleaners: '',
                patchHoles: '', handymanNotes: '' 
            },
            rooms: [
                { id: 1, name: 'Living Rm', curtains: createEmptyCurtains() },
                { id: 2, name: 'Dining Rm', curtains: createEmptyCurtains() },
                { id: 3, name: 'Master Bedroom', curtains: createEmptyCurtains() },
                { id: 4, name: 'Guest Rm', curtains: createEmptyCurtains() }
            ]
        };
        
        const defaultPrices = { Blackout: '1', Day: '1', Night: '1', 'Roman Blinds': '15', Belts: '2', pricePerCleaner: '50', cleaningSuppliesPrice: '0' };
        const PRICE_UNITS = { 'Blackout': '(per pleat)', 'Day': '(per pleat)', 'Night': '(per pleat)', 'Roman Blinds': '(per sq/m)', 'Belts': '(per piece)', 'pricePerCleaner': '(per cleaner)', 'cleaningSuppliesPrice': '(fixed fee)' };

        function appReducer(state, action) {
            switch (action.type) {
                case 'SET_CUSTOMER': return { ...state, customer: { ...state.customer, ...action.payload } };
                case 'SET_SERVICES': return { ...state, services: { ...state.services, ...action.payload } };
                case 'ADD_ROOM': return { ...state, rooms: [...state.rooms, { id: Date.now(), name: action.payload, curtains: createEmptyCurtains() }] };
                case 'DELETE_ROOM': return { ...state, rooms: state.rooms.filter(r => r.id !== action.payload) };
                case 'UPDATE_SINGLE_CURTAIN_DATA': 
                    return { ...state, rooms: state.rooms.map(room => room.id === action.payload.id ? { ...room, curtains: { ...room.curtains, [action.payload.type]: action.payload.newData } } : room )};
                case 'ADD_PLEAT_ITEM':
                    return { ...state, rooms: state.rooms.map(room => room.id === action.payload.roomId ? { ...room, curtains: { ...room.curtains, [action.payload.type]: [ ...room.curtains[action.payload.type], { id: Date.now(), pleats: '', qty: 0 } ] } } : room )};
                case 'DELETE_PLEAT_ITEM':
                    return { ...state, rooms: state.rooms.map(room => room.id === action.payload.roomId ? { ...room, curtains: { ...room.curtains, [action.payload.type]: room.curtains[action.payload.type].filter(item => item.id !== action.payload.itemId) } } : room )};
                case 'UPDATE_PLEAT_ITEM':
                    return { ...state, rooms: state.rooms.map(room => room.id === action.payload.roomId ? { ...room, curtains: { ...room.curtains, [action.payload.type]: room.curtains[action.payload.type].map(item => item.id === action.payload.itemId ? action.payload.newData : item ) } } : room )};
                case 'RESET': return defaultState;
                default: return state;
            }
        }

        // --- Main App Component ---
        function App() {

            const migrateState = (loadedState) => {
                try {
                    let migrationNeeded = false;
                    if (loadedState.rooms && loadedState.rooms.length > 0 && loadedState.rooms[0].curtains && !Array.isArray(loadedState.rooms[0].curtains.Blackout)) {
                        migrationNeeded = true;
                        const newRooms = loadedState.rooms.map(room => {
                            const newCurtains = { ...room.curtains };
                            pleatTypes.forEach(type => {
                                if (newCurtains[type] && typeof newCurtains[type] === 'object' && !Array.isArray(newCurtains[type])) {
                                    newCurtains[type] = [ { id: Date.now(), ...newCurtains[type] } ];
                                } else if (!newCurtains[type] || (Array.isArray(newCurtains[type]) && newCurtains[type].length === 0)) { 
                                    newCurtains[type] = [ { id: Date.now(), pleats: '', qty: 0 } ];
                                }
                            });
                            return { ...room, curtains: newCurtains };
                        });
                        loadedState.rooms = newRooms;
                    }
                    if (loadedState.services.patchHoles === undefined) {
                        loadedState.services.patchHoles = ''; loadedState.services.handymanNotes = '';
                        migrationNeeded = true;
                    }
                    if (migrationNeeded) console.log("Migration complete.");
                } catch (e) { return defaultState; }
                return loadedState;
            };

            const [state, dispatch] = useReducer(appReducer, loadState(DATA_KEY, defaultState), migrateState);
            const [priceList, setPriceList] = useState(() => loadState(PRICE_KEY, defaultPrices));
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            
            // --- NEW TAB STATE ---
            const [activeTab, setActiveTab] = useState('curtains'); // curtains, cleaning, handyman, summary

            const [totalAmount, setTotalAmount] = useState(0); 
            const [cleaningAmount, setCleaningAmount] = useState(0); 
            const [curtainAmount, setCurtainAmount] = useState(0); 

            useEffect(() => { const handler = setTimeout(() => { localStorage.setItem(DATA_KEY, JSON.stringify(state)); }, 3000); return () => clearTimeout(handler); }, [state]);
            useEffect(() => { localStorage.setItem(PRICE_KEY, JSON.stringify(priceList)); }, [priceList]);

            useEffect(() => {
                let curtainTotal = 0;
                const prices = priceList;
                state.rooms.forEach(room => {
                    Object.entries(room.curtains).forEach(([type, data]) => {
                        if (Array.isArray(data)) { 
                            data.forEach(item => {
                                const qty = parseInt(item.qty) || 0; if (qty === 0) return;
                                const price = parseFloat(prices[type]) || 0; const pleats = parseInt(item.pleats) || 0;
                                curtainTotal += pleats * qty * price;
                            });
                        } else { 
                            const item = data; const qty = parseInt(item.qty) || 0; if (qty === 0) return;
                            const price = parseFloat(prices[type]) || 0;
                            if (type === 'Roman Blinds') {
                                const dims = item.romanDims || {}; let length = parseFloat(dims.length) || 0; let height = parseFloat(dims.height) || 0;
                                if (dims.unit === 'cm') { length = length / 100; height = height / 100; }
                                curtainTotal += (length * height) * price * qty;
                            } else if (type === 'Belts') { curtainTotal += qty * price; }
                        }
                    });
                });
                const cleaners = parseFloat(state.services.neededCleaners) || 0;
                const pricePer = parseFloat(prices.pricePerCleaner) || 0;
                const suppliesPrice = parseFloat(prices.cleaningSuppliesPrice) || 0; 
                const newCleaningTotal = (cleaners * pricePer) + suppliesPrice;
                setCurtainAmount(curtainTotal); setCleaningAmount(newCleaningTotal); setTotalAmount(curtainTotal + newCleaningTotal); 
            }, [state.rooms, state.services.neededCleaners, priceList]);

            const handlePrint = () => window.print();
            const handleReset = () => {
                if(confirm("Reset Form? This will clear all data and prices.")) {
                    dispatch({ type: 'RESET' }); setPriceList(defaultPrices);
                    localStorage.removeItem(DATA_KEY); localStorage.removeItem(PRICE_KEY);
                    window.location.reload(); 
                }
            };
            
            const totalPieces = useMemo(() => 
                state.rooms.reduce((total, room) => total + Object.values(room.curtains).reduce((sum, data) => {
                    if (Array.isArray(data)) { return sum + data.reduce((arrSum, item) => arrSum + (parseInt(item.qty) || 0), 0); } 
                    else { return sum + (parseInt(data?.qty) || 0); }
                }, 0), 0), [state.rooms]);

            return (
                <div className="min-h-screen pb-24 bg-slate-50">
                    <nav className="bg-primary text-white px-4 py-3 shadow-lg sticky top-0 z-50 no-print backdrop-blur-sm bg-opacity-95">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="p-1.5 bg-white/20 rounded-lg"><Icons.CheckSquare /></div>
                                <span className="font-bold tracking-wide">SiteCheck V19</span>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-primaryLight hover:text-white hover:bg-white/10 rounded-full transition-all" title="Settings"><Icons.Settings /></button>
                                <button onClick={handleReset} className="p-2 text-primaryLight hover:text-white hover:bg-white/10 rounded-full transition-all" title="Reset Form"><Icons.Trash2 /></button>
                                <button onClick={handlePrint} className="p-2 bg-white text-primary rounded-full shadow-md hover:bg-primaryLight transition-all" title="Save/Print"><Icons.Save /></button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-md mx-auto p-4 print:max-w-none print:p-0">
                        
                        {/* Client Details (Always Visible) */}
                        <Card className="page-break border-t-4 border-t-primary">
                            <CardHeader title="Client Details" icon={<Icons.User />} />
                            <div className="p-5 space-y-4">
                                <InputGroup label="Name" value={state.customer.name} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { name: e.target.value }})} placeholder="Full Name" />
                                <div className="mb-3">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="block text-xs font-bold text-slate-500 uppercase">Address</label>
                                        <button onClick={() => state.customer.address && window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(state.customer.address)}`, '_blank')} disabled={!state.customer.address} className="flex items-center gap-1 text-xs text-primary font-bold disabled:opacity-50 no-print"><Icons.MapPin /><span className="pt-px">Open Map</span></button>
                                    </div>
                                    <input type="text" value={state.customer.address} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { address: e.target.value }})} placeholder="Unit, Street, Building" className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm transition-shadow" />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <InputGroup label="Contact" value={state.customer.contact} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { contact: e.target.value }})} type="tel" />
                                    <InputGroup label="Email" value={state.customer.email} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { email: e.target.value }})} type="email" />
                                </div>
                                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 mt-2 grid grid-cols-2 gap-4">
                                    <InputGroup label="Appt Date" type="datetime-local" value={state.customer.apptDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { apptDate: e.target.value }})} />
                                    <InputGroup label="Curtains Collection" type="date" value={state.customer.collectionDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { collectionDate: e.target.value }})} className="print:bg-yellow-50" />
                                    <div className="col-span-2">
                                        <InputGroup label="Clean / Install Date" type="date" value={state.customer.cleanDate} onChange={e => dispatch({ type: 'SET_CUSTOMER', payload: { cleanDate: e.target.value }})} />
                                    </div>
                                </div>
                            </div>
                        </Card>

                        {/* --- TAB NAVIGATION BAR (New) --- */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex overflow-hidden mb-5 tab-nav-bar">
                            <TabButton label="Curtains" icon={<Icons.Layers />} isActive={activeTab === 'curtains'} onClick={() => setActiveTab('curtains')} />
                            <TabButton label="Cleaning" icon={<Icons.AppWindow />} isActive={activeTab === 'cleaning'} onClick={() => setActiveTab('cleaning')} />
                            <TabButton label="Handyman" icon={<Icons.Hammer />} isActive={activeTab === 'handyman'} onClick={() => setActiveTab('handyman')} />
                            <TabButton label="Summary" icon={<Icons.Calculator />} isActive={activeTab === 'summary'} onClick={() => setActiveTab('summary')} />
                        </div>

                        {/* --- TAB CONTENT SECTIONS --- 
                            Logic: Use className to toggle display on screen, but allow PRINT styles to force display:block 
                        */}

                        {/* 1. CURTAINS SECTION */}
                        <div className={`tab-content ${activeTab === 'curtains' ? 'block' : 'hidden'}`}>
                            <SectionTitle title="Room Assessment" />
                            <div className="space-y-5">
                                {state.rooms.map((room) => (
                                    <RoomCard key={room.id} room={room} dispatch={dispatch} />
                                ))}
                                <button onClick={() => { const name = prompt("Enter Room Name:"); if (name) dispatch({ type: 'ADD_ROOM', payload: name }); }}
                                    className="w-full py-4 border-2 border-dashed border-primary/40 text-primary rounded-xl flex items-center justify-center gap-2 hover:bg-primaryLight hover:border-primary transition-all no-print font-bold uppercase tracking-wide text-sm">
                                    <Icons.Plus /> Add New Room
                                </button>
                            </div>
                        </div>

                        {/* 2. CLEANING SECTION */}
                        <div className={`tab-content ${activeTab === 'cleaning' ? 'block' : 'hidden'}`}>
                            <SectionTitle title="Additional Info" />
                            <Card className="page-break">
                                <CardHeader title="Site Condition" icon={<Icons.AppWindow />} />
                                <div className="p-5 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <InputGroup label="No. of Windows" type="number" value={state.services.windows} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { windows: e.target.value }})} />
                                        <InputGroup label="Kitchen Condition" value={state.services.kitchenCondition} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { kitchenCondition: e.target.value }})} />
                                        <InputGroup label="Bedrooms" type="number" value={state.services.bedroomsCount} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { bedroomsCount: e.target.value }})} />
                                        <InputGroup label="Bathrooms" type="number" value={state.services.bathroomsCount} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { bathroomsCount: e.target.value }})} />
                                    </div>
                                    <InputGroup label="Cupboards & Shelves" value={state.services.cupboards} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { cupboards: e.target.value }})} />
                                    <InputGroup label="Roller Blinds" type="text" value={state.services.rollerBlinds} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { rollerBlinds: e.target.value }})} placeholder="e.g. 2 pcs, dusty" />
                                    <div className="grid grid-cols-2 gap-4">
                                        <InputGroup label="Mosquito-nets" type="number" value={state.services.mosquitoNets} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { mosquitoNets: e.target.value }})} />
                                        <InputGroup label="Balconies" type="number" value={state.services.balconies} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { balconies: e.target.value }})} />
                                    </div>
                                    <div className="pt-4 border-t border-slate-200 mt-2">
                                        <div className="grid grid-cols-2 gap-4">
                                            <InputGroup label="Needed Cleaners" type="number" step="0.5" value={state.services.neededCleaners} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { neededCleaners: e.target.value }})} placeholder="e.g. 1.5" />
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Est. Cleaning Amount</label>
                                                <input type="text" value={`$${cleaningAmount.toFixed(2)}`} readOnly disabled className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-100 text-slate-500 font-bold" />
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Inspector Notes <span className="ml-2 text-[10px] font-normal text-slate-400 normal-case no-print">(*yellow*, #red#)</span></label>
                                        <textarea rows="6" className="w-full px-4 py-3 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary bg-slate-50" value={state.services.others} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { others: e.target.value }})} placeholder="Enter special requirements..."></textarea>
                                        <FormattedNote text={state.services.others} />
                                    </div>
                                </div>
                            </Card>
                        </div>

                        {/* 3. HANDYMAN SECTION */}
                        <div className={`tab-content ${activeTab === 'handyman' ? 'block' : 'hidden'}`}>
                            <SectionTitle title="Handyman" />
                            <Card className="page-break">
                                <CardHeader title="Handyman Services" icon={<Icons.Hammer />} />
                                <div className="p-5 space-y-4">
                                    <div className="w-1/2 pr-2">
                                         <InputGroup label="Patch Holes" value={state.services.patchHoles} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { patchHoles: e.target.value }})} placeholder="Qty / Loc" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Description / Notes</label>
                                        <textarea rows="6" className="w-full px-4 py-3 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary bg-slate-50" value={state.services.handymanNotes} onChange={e => dispatch({ type: 'SET_SERVICES', payload: { handymanNotes: e.target.value }})} placeholder="Describe handyman tasks..."></textarea>
                                        <FormattedNote text={state.services.handymanNotes} />
                                    </div>
                                </div>
                            </Card>
                        </div>

                        {/* 4. SUMMARY / QUOTATION SECTION (Also shown on print) */}
                        <div className={`tab-content ${activeTab === 'summary' ? 'block' : 'hidden'}`}>
                            <SectionTitle title="Quotation" />
                            <Card className="bg-gradient-to-br from-white to-slate-50 border-primary/20 page-break shadow-md">
                                <CardHeader title="Summary" icon={<Icons.Calculator />} />
                                <div className="p-5">
                                    <div className="flex justify-between items-center mb-6 pb-6 border-b border-slate-200">
                                        <span className="font-bold text-slate-500 uppercase text-xs tracking-wider">Total Curtain Qty</span>
                                        <span className="text-3xl font-bold text-slate-700">{totalPieces} <span className="text-sm font-normal text-slate-400">pcs</span></span>
                                    </div>
                                    <div className="mb-4">
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Curtains Price ($)</label>
                                        <input type="text" placeholder="0.00" value={curtainAmount.toFixed(2)} readOnly disabled className="w-full text-right text-2xl font-bold text-slate-700 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2" />
                                    </div>
                                    <div className="bg-primaryLight p-4 rounded-xl border border-primary/20">
                                        <label className="block text-xs font-bold text-primaryDark uppercase mb-1">Grand Total Amount ($)</label>
                                        <input type="text" placeholder="0.00" value={totalAmount.toFixed(2)} readOnly className="w-full text-right text-3xl font-bold text-primary bg-transparent outline-none placeholder-teal-200/50" />
                                    </div>
                                </div>
                            </Card>
                        </div>

                        <div className="hidden print:flex mt-12 pt-8 border-t-2 border-slate-200 page-break justify-between items-end">
                            <div className="text-center w-1/3"><div className="h-16 border-b border-slate-400 mb-2"></div><div className="text-xs font-bold text-slate-500 uppercase">Customer Signature</div></div>
                            <div className="text-center w-1/3"><div className="h-16 border-b border-slate-400 mb-2"></div><div className="text-xs font-bold text-slate-500 uppercase">Inspector Signature</div></div>
                        </div>
                        
                        <div className="text-center mt-8 no-print text-slate-400 text-xs">Â© Site Assessment App V19</div>
                    </main>
                    
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} priceList={priceList} setPriceList={setPriceList} />
                </div>
            );
        }

        // --- Child Components (Same as before) ---

        function SettingsModal({ isOpen, onClose, priceList, setPriceList }) {
            const dialogRef = React.useRef(null);
            useEffect(() => { if (isOpen) dialogRef.current?.showModal(); else dialogRef.current?.close(); }, [isOpen]);
            const handlePriceChange = (type, value) => { setPriceList(prev => ({ ...prev, [type]: value })); };
            return (
                <dialog ref={dialogRef} onClose={onClose} className="w-full max-w-md p-0 no-print">
                    <div className="flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b border-slate-200">
                            <div className="flex items-center gap-2"><span className="text-primary"><Icons.DollarSign /></span><h3 className="text-lg font-bold text-slate-800">Price List</h3></div>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icons.X /></button>
                        </div>
                        <div className="p-6 space-y-4 bg-slate-50">
                            <p className="text-sm text-slate-600">Set default prices for auto-calculation.</p>
                            {curtainTypes.map(type => (
                                <div key={type} className="flex items-center gap-2"><label className="w-1/2 text-sm font-medium text-slate-700">{type} <span className="text-xs text-slate-400 font-normal">{PRICE_UNITS[type]}</span></label><div className="relative w-1/2"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span><input type="number" value={priceList[type] || ''} onChange={(e) => handlePriceChange(type, e.target.value)} className="w-full pl-7 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary" /></div></div>
                            ))}
                            <div className="pt-4 border-t border-slate-200 mt-4 space-y-4">
                                <div className="flex items-center gap-2"><label className="w-1/2 text-sm font-medium text-slate-700">Cleaning Staff <span className="text-xs text-slate-400 font-normal">{PRICE_UNITS['pricePerCleaner']}</span></label><div className="relative w-1/2"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span><input type="number" value={priceList['pricePerCleaner'] || ''} onChange={(e) => handlePriceChange('pricePerCleaner', e.target.value)} className="w-full pl-7 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary" /></div></div>
                                <div className="flex items-center gap-2"><label className="w-1/2 text-sm font-medium text-slate-700">Cleaning Supplies <span className="text-xs text-slate-400 font-normal">{PRICE_UNITS['cleaningSuppliesPrice']}</span></label><div className="relative w-1/2"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span><input type="number" value={priceList['cleaningSuppliesPrice'] || ''} onChange={(e) => handlePriceChange('cleaningSuppliesPrice', e.target.value)} className="w-full pl-7 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary" /></div></div>
                            </div>
                        </div>
                        <div className="p-4 bg-slate-100 border-t border-slate-200 text-right"><button onClick={onClose} className="bg-primary text-white px-5 py-2 rounded-lg font-semibold text-sm hover:bg-primaryDark transition-colors">Done</button></div>
                    </div>
                </dialog>
            );
        }

        function RoomCard({ room, dispatch }) {
            const total = useMemo(() => Object.values(room.curtains).reduce((sum, data) => { if (Array.isArray(data)) { return sum + data.reduce((arrSum, item) => arrSum + (parseInt(item.qty) || 0), 0); } else { return sum + (parseInt(data?.qty) || 0); } }, 0), [room.curtains]);
            const handleDelete = () => { if(confirm(`Delete room "${room.name}"?`)) { dispatch({ type: 'DELETE_ROOM', payload: room.id }); } };
            const handleAddPleat = (type) => { dispatch({ type: 'ADD_PLEAT_ITEM', payload: { roomId: room.id, type } }); };
            const handleDeletePleat = (type, itemId) => { dispatch({ type: 'DELETE_PLEAT_ITEM', payload: { roomId: room.id, type, itemId } }); };
            const handleUpdatePleat = (type, itemId, newData) => { dispatch({ type: 'UPDATE_PLEAT_ITEM', payload: { roomId: room.id, type, itemId, newData } }); };
            const handleUpdateSingle = (type, newData) => { dispatch({ type: 'UPDATE_SINGLE_CURTAIN_DATA', payload: { id: room.id, type, newData } }); };
            return (
                <Card className="page-break transition-all hover:shadow-md">
                    <div className="bg-white px-4 py-3 border-b border-slate-100 flex justify-between items-center"><span className="font-bold text-slate-700 text-lg">{room.name}</span><div className="flex items-center gap-3"><span className="text-xs font-bold px-2.5 py-1 rounded-full bg-primaryLight text-primary border border-teal-100">{total} pcs</span><button onClick={handleDelete} className="text-slate-300 hover:text-red-500 no-print transition-colors"><Icons.X /></button></div></div>
                    <div className="p-3 bg-white">
                        {curtainTypes.map((type) => {
                            const isPleatType = pleatTypes.includes(type);
                            if (isPleatType) {
                                return (
                                    <div key={type} className="py-3 border-b border-slate-100 last:border-0">
                                        {Array.isArray(room.curtains[type]) && room.curtains[type].map((item, index) => (
                                            <CurtainInput key={item.id} label={type} data={item} onChange={(newData) => handleUpdatePleat(type, item.id, newData)} onDelete={() => handleDeletePleat(type, item.id)} isPleatType={true} showLabel={index === 0} canDelete={room.curtains[type].length > 1} />
                                        ))}
                                        <div className="flex justify-end mt-2 pr-12 no-print"><button onClick={() => handleAddPleat(type)} className="flex items-center gap-1 text-xs text-primary font-bold opacity-70 hover:opacity-100"><Icons.Plus /><span className="pt-px">Add {type}</span></button></div>
                                    </div>
                                );
                            } else { return ( <CurtainInput key={type} label={type} data={room.curtains[type]} onChange={(newData) => handleUpdateSingle(type, newData)} isPleatType={false} showLabel={true} canDelete={false} onDelete={() => {}} /> ); }
                        })}
                    </div>
                </Card>
            );
        }

        function CurtainInput({ label, data, onChange, onDelete, isPleatType, showLabel, canDelete }) {
            if (!data) return null; 
            const isRomanBlind = label === 'Roman Blinds'; const isBelt = label === 'Belts';
            const handleQtyChange = (newQty) => onChange({ ...data, qty: Math.max(0, newQty) });
            const handlePleatChange = (e) => onChange({ ...data, pleats: e.target.value });
            const handleRomanChange = (field, val) => { const currentDims = data.romanDims || { length: '', height: '', unit: 'cm' }; const newDims = { ...currentDims, [field]: val }; onChange({ ...data, romanDims: newDims }); };
            const romanDims = data.romanDims || { length: '', height: '', unit: 'cm' };
            const wrapperClass = isPleatType ? "py-1.5" : "py-3 border-b border-slate-100 last:border-0";
            return (
                <div className={wrapperClass}>
                    <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                        <div className="flex items-center gap-2 w-full sm:w-1/3">
                           {showLabel ? ( <React.Fragment><span className={`text-sm font-medium ${isRomanBlind || isPleatType ? 'text-primaryDark font-bold' : 'text-slate-700'}`}>{label}</span>{isRomanBlind && <span className="text-[10px] bg-teal-100 text-teal-800 px-1 rounded no-print">L x H (sq/m)</span>}{isPleatType && <span className="text-[10px] bg-teal-100 text-teal-800 px-1 rounded no-print">Pleats</span>}</React.Fragment> ) : ( <button onClick={onDelete} className={`text-slate-300 hover:text-red-500 no-print transition-colors ml-1 ${!canDelete ? 'opacity-70' : ''}`} title="Remove item" disabled={!canDelete}><Icons.X /></button> )}
                        </div>
                        <div className="flex items-center gap-2 w-full sm:w-2/3 justify-end">
                            <div className="flex-1">
                                {isRomanBlind && ( <div className="flex items-center gap-1"><input type="number" value={romanDims.length} onChange={(e) => handleRomanChange('length', e.target.value)} placeholder="Len" className="w-1/3 min-w-[50px] px-1 py-1 text-center border border-slate-300 rounded text-sm focus:border-primary outline-none" /><span className="text-slate-400 text-xs">x</span><input type="number" value={romanDims.height} onChange={(e) => handleRomanChange('height', e.target.value)} placeholder="Hgt" className="w-1/3 min-w-[50px] px-1 py-1 text-center border border-slate-300 rounded text-sm focus:border-primary outline-none" /><select value={romanDims.unit} onChange={(e) => handleRomanChange('unit', e.target.value)} className="w-1/3 min-w-[50px] bg-slate-50 border border-slate-300 text-xs rounded px-1 py-1 outline-none focus:border-primary"><option value="cm">cm</option><option value="m">m</option></select></div> )}
                                {isPleatType && ( <div className="relative max-w-[120px]"><input type="number" value={data.pleats || ''} onChange={handlePleatChange} placeholder="Pleats No." className="w-full px-2 py-1 text-center border border-slate-300 rounded text-sm focus:border-primary outline-none" /></div> )}
                                {isBelt && ( <div className="relative max-w-[120px]"><input type="text" value="Per Piece" readOnly disabled className="w-full px-2 py-1 text-center border-slate-200 bg-slate-50 text-slate-400 rounded text-sm outline-none" /></div> )}
                            </div>
                            <div className="flex items-center gap-1 ml-2"><button onClick={() => handleQtyChange((data.qty || 0) - 1)} className="w-7 h-7 flex items-center justify-center rounded bg-slate-100 text-slate-600 hover:bg-slate-200 active:bg-slate-300 touch-manipulation no-print shadow-sm">-</button><div className="w-10 text-center"><input type="number" value={data.qty || 0} onChange={(e) => handleQtyChange(parseInt(e.target.value) || 0)} className="w-full text-center py-1 border border-slate-300 rounded text-sm font-bold bg-white text-primaryDark" /></div><button onClick={() => handleQtyChange((data.qty || 0) + 1)} className="w-7 h-7 flex items-center justify-center rounded bg-primary text-white hover:bg-primaryDark active:opacity-80 touch-manipulation no-print shadow-sm">+</button></div>
                            {isPleatType && showLabel && ( <button onClick={onDelete} className={`text-slate-300 hover:text-red-500 no-print transition-colors ml-1 ${!canDelete ? 'opacity-0' : ''}`} title="Remove item" disabled={!canDelete}><Icons.X /></button> )}
                        </div>
                    </div>
                </div>
            );
        };

        window.renderTheApp = () => { const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />); };
    </script>
</body>
</html>


